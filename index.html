
<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover" />
  <title>Workout Tracker</title>
  <meta name="theme-color" content="#0b0b0c" />
  <link rel="icon" href="https://ik.imagekit.io/tgquwnwxx/Frame%2044.svg" type="image/svg">
  <link rel="apple-touch-icon" href="https://ik.imagekit.io/tgquwnwxx/Frame%2044.svg">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  :root{
    --bg:#0b0b0c;
    --panel:#121214;
    --border:#2a2a2a;
    --text:#ffffff;
    --muted:rgba(255,255,255,.70);
    --accent:#ffffff;
    --btn:#ffffff;
    --btnText:#000000;
    --btn2:#1a1a1b;
    --btn2Text:#ffffff;
    --danger:#ff6b6b;
    --success:#32d583;
  }

  /* Pink theme: тёмная база + розовый акцент */
[data-theme="pink"]{
  --bg: linear-gradient(
    180deg,
    #000000 0%,
    #220620 100%
  );

  --panel:#161116;
  --border:#2a1d27;
  --text:#ffffff;
  --muted:rgba(255,255,255,.65);
  --accent:#dd77af;
  --btn:#dd77af;
  --btnText:#ffffff;
  --btn2:#1e161c;
  --btn2Text:#ffffff;
}

  /* Pink theme: delta colors */
[data-theme="pink"] .delta.up,
[data-theme="pink"] .deltaPlus{
  color: #FF5FBF; /* PLUS */
}

[data-theme="pink"] .delta.down,
[data-theme="pink"] .deltaMinus{
  color: #8A7CA8; /* MINUS */
}


  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background:var(--bg);
    color:var(--text);
  }
  .wrap{max-width:420px;margin:0 auto;padding:16px 14px 28px}
  .topbar{
    display:flex; align-items:center; justify-content:space-between;
    gap:12px; margin:8px 0 14px;
  }
  .brand{display:flex; align-items:center; gap:10px}
  .logo{
    width:40px;height:40px;border-radius:16px;
    border:1px solid var(--border);
    background:var(--panel);
    display:grid;place-items:center;
    font-weight:900;color:var(--accent);
  }
  .title{line-height:1.1}
  .title b{display:block;font-size:14px}
  .title span{display:block;font-size:12px;color:var(--muted);margin-top:2px}
  .right{display:flex;align-items:center;gap:10px}
  .switch{
    display:flex; align-items:center; gap:8px;
    border:1px solid var(--border); background:var(--panel);
    padding:6px 10px;border-radius:999px;
    font-size:12px;color:var(--muted);
  }
  .toggle{
    width:42px;height:24px;border-radius:999px;
    border:1px solid var(--border);
    background:rgba(0,0,0,.06);
    position:relative; cursor:pointer;
  }
  .knob{
    position:absolute; top:2px; left:2px;
    width:20px; height:20px; border-radius:999px;
    background:var(--btn);
    transition:transform .18s ease;
  }
  [data-theme="pink"] .knob{ transform:translateX(18px); }

  .iconbtn{
    width:40px;height:40px;border-radius:16px;
    border:1px solid var(--border); background:var(--panel);
    color:var(--text); cursor:pointer;
  }
  .card{
    border:1px solid var(--border);
    background:var(--panel);
    border-radius:22px;
    padding:14px;
    margin:12px 0;
  }
  h2{margin:0 0 6px;font-size:18px}
  .muted{color:var(--muted);font-size:13px}
  label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}

  input, select, textarea{
    width:100%;
    padding:12px 12px;
    border-radius:14px;
    border:1px solid var(--border);
    background:transparent;
    color:var(--text);
    outline:none;

    /* iOS Safari: не зумит при фокусе */
    font-size:16px;
    -webkit-text-size-adjust:100%;
  }

  input::placeholder{color:rgba(255,255,255,.35)}
  [data-theme="pink"] input::placeholder{color:rgba(255,255,255,.35)}

  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .btn{
    width:100%;
    border:none;
    padding:12px 14px;
    border-radius:16px;
    cursor:pointer;
    font-weight:700;
  }
  .btn.primary{background:var(--btn);color:var(--btnText)}
  .btn.secondary{background:var(--btn2);color:var(--btn2Text);border:1px solid var(--border)}
  .btn:disabled{opacity:.55;cursor:not-allowed}
  .alert{
    border:1px solid var(--border);
    border-radius:16px;
    padding:10px 12px;
    font-size:13px;color:var(--muted);
    margin:10px 0 0;
  }
  .alert b{color:var(--danger)}

  /* Tabs: горизонтальный скролл */
  .tabs{
    display:flex;
    gap:6px;
    border:1px solid var(--border);
    background:var(--panel);
    border-radius:18px;
    padding:6px;
    position:sticky; top:0; z-index:10;
    overflow-x:auto;
    -webkit-overflow-scrolling:touch;
    scrollbar-width:none;
  }
  .tabs::-webkit-scrollbar{display:none;}

  #screenApp.swiping{
    position:relative;
    overflow:hidden;
  }
  #screenApp.swiping .tabpane.swipe-layer{
    position:absolute;
    left:0;
    right:0;
    top:var(--tabsH);
    height:calc(100% - var(--tabsH));
    will-change:transform;
  }
  #screenApp.swiping .tabpane.swipe-layer.swipe-anim{
    transition:transform 220ms cubic-bezier(.22,.61,.36,1);
  }
  #screenApp.swiping .tabpane.swipe-layer.swipe-current{z-index:2;}
  #screenApp.swiping .tabpane.swipe-layer.swipe-next{z-index:1;}
  #screenApp.swiping .tabpane.swipe-layer.swipe-next::before{
    content:"";
    position:absolute;
    inset:0;
    background:rgba(0,0,0,.05);
    opacity:var(--dim,0);
    pointer-events:none;
    transition:opacity 220ms cubic-bezier(.22,.61,.36,1);
  }

  #bodyWeightChart{ width:100%; height:220px; }

  .tab{
    flex:0 0 auto;
    padding:10px 10px;
    border-radius:14px;
    font-size:12px;
    text-align:center;
    cursor:pointer;
    color:var(--muted);
    user-select:none;
    border:1px solid transparent;
    white-space:nowrap;
  }
  .tab.active{
    background:rgba(0,0,0,.06);
    border-color:var(--border);
    color:var(--text);
  }
  [data-theme="pink"] .tab.active{
    background:rgba(255,62,168,.10);
  }

  .grid3{display:grid;grid-template-columns:1fr;gap:10px}
  .workoutCard{
    border:1px solid var(--border);
    background:var(--panel);
    border-radius:22px;
    padding:14px;
    cursor:pointer;
  }
  .workoutCard:hover{opacity:.95}
  .workoutCard h3{margin:0;font-size:16px}

  .pill{
    display:inline-block;
    padding:7px 10px;
    border-radius:999px;
    border:1px solid var(--border);
    background:transparent;
    color:var(--muted);
    font-size:12px;
    margin:6px 6px 0 0;
    cursor:pointer;
  }
  .pill.active{
    background:var(--btn);
    color:var(--btnText);
    border-color:transparent;
  }

  table{
    width:100%;
    border-collapse:collapse;
    overflow:hidden;
    border-radius:18px;
    border:1px solid var(--border);
  }
  th, td{
    padding:10px 10px;
    border-bottom:1px solid rgba(255,255,255,.10);
    font-size:13px;
    text-align:left;
  }
  [data-theme="pink"] th, [data-theme="pink"] td{
    border-bottom:1px solid rgba(255,255,255,.10);
  }
  th{color:var(--muted);font-weight:700;background:rgba(255,255,255,.06)}
  [data-theme="pink"] th{background:rgba(255,255,255,.06)}
  tr:last-child td{border-bottom:none}

  .actions{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px}
  .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}

  .kpi{
    border:1px solid var(--border);
    background:rgba(255,255,255,.04);
    border-radius:18px;
    padding:12px;
    margin-top:10px;
  }

  .bar{
    height:10px;border-radius:999px;
    background:rgba(255,255,255,.10);
    overflow:hidden;border:1px solid var(--border);
    margin-top:8px;
  }
.bar > div{
  height:100%;
  width:0%;
  background: var(--btn); /* pink возьмёт розовый */
  transition:width .25s ease;
}

/* black theme (когда data-theme НЕ pink) */
:root:not([data-theme="pink"]) .bar > div{
  background: linear-gradient(90deg, rgba(122,180,255,.55), rgba(122,180,255,1));
}

  .deltaPlus{color:var(--success);font-weight:900}
  .deltaMinus{color:var(--danger);font-weight:900}
  .footer{margin-top:18px;text-align:center;font-size:11px;color:var(--muted)}

  /* ---------------------------
     FIX: Progress table on iPhone
     --------------------------- */
  .tableScroll{
    width:100%;
    overflow-x:auto;
    -webkit-overflow-scrolling:touch;
  }
  .tableScroll table{
    width:100%;
    min-width:520px; /* чтобы Δ не уезжал */
  }
  #progressTableWrap th,
  #progressTableWrap td{
    white-space:nowrap;
  }
  #progressTableWrap th:first-child,
  #progressTableWrap td:first-child{
    white-space:normal;
    word-break:break-word;
    width:48%;
  }
  #progressTableWrap th:nth-child(2),
  #progressTableWrap td:nth-child(2),
  #progressTableWrap th:nth-child(3),
  #progressTableWrap td:nth-child(3){
    width:18%;
  }
  #progressTableWrap th:nth-child(4),
  #progressTableWrap td:nth-child(4){
    width:16%;
    text-align:right;
  }

.delta{font-weight:900}
.delta.up{color:var(--success)}  /* + */
.delta.down{color:var(--danger)} /* - */
.delta.eq{color:rgba(255,255,255,.65)}

.deltaBig{
  font-size:19px;
  font-weight:900;
  letter-spacing:.2px;
}
:root:not([data-theme="pink"]) .deltaBig{
  color:#4da3ff;
  text-shadow:0 0 12px rgba(77,163,255,.25);
}
[data-theme="pink"] .deltaBig{
  color:var(--btn);
}

.noteHint{
  margin-top:6px;
  font-size:12px;
  color:var(--muted);
}

  .workoutHead{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:10px;
}

.workoutMeta{ min-width:0; }

.workoutMeta h3{
  margin:0;
  font-size:16px;
}

.workoutDel{
  width:34px;
  height:34px;
  border-radius:12px;
  border:1px solid var(--border);
  background:transparent;
  color:var(--muted);
  cursor:pointer;
  flex:0 0 auto;
}

.workoutDel:hover{
  color:var(--danger);
  border-color:rgba(255,107,107,.45);
}


/* Loading screen */
.loadingScreen{
  position:fixed;
  inset:0;
  z-index:99999;
  display:flex;
  align-items:center;
  justify-content:center;
  background:var(--bg);
}

.loadingInner{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:12px;
  padding:18px 16px;
  border-radius:22px;
}

.loadingText{
  font-size:14px;
  font-weight:800;
  color:var(--muted);
  letter-spacing:.2px;
}

/* Spinner */
.spinner{
  width:34px;
  height:34px;
  border-radius:999px;
  border:3px solid rgba(255,255,255,.16);
  border-top-color: var(--btn);
  animation:spin .9s linear infinite;
}

/* Pink: можно чуть ярче */
[data-theme="pink"] .spinner{
  border:3px solid rgba(255,255,255,.14);
  border-top-color: var(--btn);
}

@keyframes spin{
  to { transform:rotate(360deg); }
}


html, body{
  -webkit-text-size-adjust: 100%;
  text-size-adjust: 100%;
}




html{
  min-height: 100%;
  background: var(--bg);
  background-repeat: no-repeat;
  background-size: cover;
}

body{
  min-height: 100vh;
  background: var(--bg);
  background-repeat: no-repeat;
  background-size: cover;
  background-attachment: fixed;
}

/* safe-area для айфонов с вырезом */
.wrap{
  padding-top: calc(16px + env(safe-area-inset-top));
  padding-right: calc(14px + env(safe-area-inset-right));
  padding-bottom: calc(28px + env(safe-area-inset-bottom));
  padding-left: calc(14px + env(safe-area-inset-left));
}

/* sticky tabs учитывают safe-area сверху */
.tabs{
  top: env(safe-area-inset-top);
}


/* --- Quick add chips --- */
.divider{height:1px; background:rgba(255,255,255,.08); margin:12px 0;}
.chips{display:flex; flex-wrap:wrap; gap:8px; margin-top:10px}
.chip{
  display:inline-flex; align-items:center; justify-content:center;
  padding:8px 10px; border-radius:999px;
  border:1px solid var(--border);
  background:transparent;
  color:var(--text);
  font-size:13px;
  cursor:pointer;
  user-select:none;
}
.chip.on{
  background:rgba(255,255,255,.08);
  border-color:rgba(255,255,255,.18);
}
[data-theme="pink"] .chip.on{
  background:rgba(255,62,168,.14);
  border-color:rgba(255,62,168,.22);
}

/* --- Previous sets box --- */
.prevBox{
  border:1px dashed rgba(255,255,255,.22);
  border-radius:16px;
  padding:10px 12px;
  margin-top:10px;
  background:rgba(0,0,0,.08);
}
[data-theme="pink"] .prevBox{ background:rgba(255,62,168,.08); border-color:rgba(255,62,168,.22); }
.prevTitle{font-weight:900; font-size:13px}
.prevGrid{display:grid; gap:6px; margin-top:8px}
.prevRow{
  display:flex; justify-content:space-between; gap:10px;
  font-size:13px;
  color:var(--muted);
}
.prevRow b{color:var(--text)}
.prevRow.current{color:var(--text)}
.prevRow.current b{color:var(--text); text-decoration:underline}

/* --- Undo toast --- */
.toast{
  position:fixed;
  left:50%;
  transform:translateX(-50%);
  bottom: calc(14px + env(safe-area-inset-bottom));
  width:min(92vw, 420px);
  background:rgba(20,20,22,.95);
  border:1px solid rgba(255,255,255,.10);
  border-radius:18px;
  padding:12px 12px;
  display:none;
  z-index:99999;
  box-shadow:0 14px 40px rgba(0,0,0,.35);
}
[data-theme="pink"] .toast{ background:rgba(26,18,25,.95); border-color:rgba(255,62,168,.12); }
.toastRow{display:flex; align-items:center; justify-content:space-between; gap:10px}
.toastMsg{font-size:13px; color:var(--muted)}
.toastBtn{
  padding:8px 10px;
  border-radius:12px;
  border:1px solid var(--border);
  background:transparent;
  color:var(--text);
  font-weight:900;
  cursor:pointer;
}


/* FIX iOS: inputs in grid may overflow (especially date) */
.row{
  display:grid;
  grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
  gap:10px; /* можешь сделать 12 если хочешь чуть больше воздуха */
}

.row > div{ min-width:0; }     /* важно для grid */
input, select, textarea{
  min-width:0;                 /* важно для iOS */
  max-width:100%;
}

/* на всякий случай именно для date */
input[type="date"]{
  max-width:100%;
}



/* ---------- Progress (vertical, no horizontal scroll) ---------- */
.progressGroups{ display:grid; gap:12px; margin-top:0; }
.progressWorkout{ padding:14px; }
.progressWorkoutHeader{
  font-weight:900;
  font-size:16px;
  margin-bottom:10px;
}
.progressExercises{ display:grid; gap:10px; }
.progressExercise{
  border:1px solid rgba(255,255,255,.10);
  border-radius:18px;
  padding:12px;
  background: rgba(255,255,255,.04);
}
[data-theme="pink"] .progressExercise{
  border-color: rgba(255,255,255,.10);
  background: rgba(255,255,255,.03);
}
.progressExerciseTitle{
  font-weight:900;
  font-size:14px;
  line-height:1.25;
  margin:0;
  word-break:break-word;
}

.pGrid{
  margin-top:10px;
  display:grid;
  grid-template-columns:1fr;
  gap:8px;
}

.pRow{
  display:flex;
  justify-content:space-between;
  align-items:baseline;
  gap:10px;
  padding:9px 10px;
  border:1px solid rgba(255,255,255,.10);
  border-radius:14px;
  background: rgba(255,255,255,.04);
}
[data-theme="pink"] .pRow{
  border-color: rgba(255,255,255,.10);
  background: rgba(255,255,255,.03);
}

.pLbl{
  color:var(--muted);
  font-size:12px;
  font-weight:800;
  letter-spacing:.15px;
}

.pVal{
  font-weight:900;
  font-size:13px;
  white-space:nowrap;
}

.pGroupTitle{
  font-weight:900;
  font-size:15px;
  margin:8px 2px 2px;
}


/* ---------- Body measurements (vertical blocks) ---------- */
.vtable{ display:grid; gap:12px; margin-top:10px; }

.vrow{
  border:1px solid rgba(255,255,255,.14);
  border-radius:18px;
  padding:12px;
  background: rgba(0,0,0,.18);
}
[data-theme="pink"] .vrow{
  border-color: rgba(255,255,255,.12);
  background: rgba(0,0,0,.14);
}

.vdate{
  font-weight:900;
  font-size:14px;
}

.vgrid{
  margin-top:10px;
  display:grid;
  gap:8px;
}

.vitem{
  display:grid;
  grid-template-columns: 1fr auto auto;
  gap:8px;
  align-items:center;
  padding:8px 10px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.04);
}
[data-theme="pink"] .vitem{
  border-color: rgba(255,255,255,.10);
  background: rgba(255,255,255,.03);
}

.vlabel{ color:var(--muted); font-size:13px; }
.vvalue{ font-weight:900; font-size:13px; white-space:nowrap; }



.dateWrap{ position:relative; }

.dateBtn{
  width:100%;
  padding:12px 12px;
  border-radius:14px;
  border:1px solid var(--border);
  background:transparent;
  color:var(--text);
  font-size:16px;
  text-align:left;
  position:relative;
  z-index:1;
}

.dateNative{
  position:absolute;
  inset:0;
  z-index:2;

  /* iOS fix: не делаем 0, иначе кликается только справа */
  opacity:0.01;

  border:0;
  background:transparent;
  cursor:pointer;

  /* важно: НЕ отключаем нативный вид у date */
  -webkit-appearance:auto;
  appearance:auto;
}

/* растянуть “кликабельную” часть на всю ширину/высоту */
.dateNative::-webkit-calendar-picker-indicator{
  opacity:0;
  display:block;
  width:100%;
  height:100%;
}



/* ---------------------------
   Micro-interactions (hover / press / focus)
   --------------------------- */

:root{
  --ease: cubic-bezier(.2,.9,.2,1);
  --dur-fast: .12s;
  --dur: .18s;
  --shadow: 0 12px 30px rgba(0,0,0,.28);
}

/* уважение к настройке "уменьшить движения" */
@media (prefers-reduced-motion: reduce){
  *{ transition: none !important; animation: none !important; scroll-behavior:auto !important; }
}

/* общий принцип: всё кликабельное с плавными трансформами */
.btn,
.iconbtn,
.tab,
.pill,
.chip,
.workoutCard,
.workoutDel,
.toastBtn,
.dateBtn{
  transition:
    transform var(--dur) var(--ease),
    box-shadow var(--dur) var(--ease),
    background-color var(--dur) var(--ease),
    border-color var(--dur) var(--ease),
    color var(--dur) var(--ease),
    opacity var(--dur-fast) ease;
  will-change: transform;
}

/* hover только там, где реально есть мышка */
@media (hover:hover) and (pointer:fine){

  .btn:hover{
    transform: translateY(-1px);
    box-shadow: var(--shadow);
  }
  .btn.secondary:hover{
    border-color: rgba(255,255,255,.22);
  }
  [data-theme="pink"] .btn.secondary:hover{
    border-color: rgba(255,62,168,.28);
  }

  .iconbtn:hover{
    transform: translateY(-1px);
    border-color: rgba(255,255,255,.20);
    box-shadow: 0 10px 24px rgba(0,0,0,.25);
  }

  .tab:hover{
    color: var(--text);
    border-color: rgba(255,255,255,.16);
    background: rgba(255,255,255,.04);
  }
  [data-theme="pink"] .tab:hover{
    background: rgba(255,62,168,.08);
    border-color: rgba(255,62,168,.18);
  }

  .pill:hover{
    transform: translateY(-1px);
    border-color: rgba(255,255,255,.18);
    color: var(--text);
    background: rgba(255,255,255,.04);
  }
  [data-theme="pink"] .pill:hover{
    background: rgba(255,62,168,.08);
    border-color: rgba(255,62,168,.18);
  }

  .chip:hover{
    transform: translateY(-1px);
    border-color: rgba(255,255,255,.20);
    background: rgba(255,255,255,.04);
  }
  [data-theme="pink"] .chip:hover{
    background: rgba(255,62,168,.08);
    border-color: rgba(255,62,168,.18);
  }

  .workoutCard:hover{
    transform: translateY(-2px);
    box-shadow: 0 18px 44px rgba(0,0,0,.30);
    border-color: rgba(255,255,255,.18);
  }
  [data-theme="pink"] .workoutCard:hover{
    border-color: rgba(255,62,168,.22);
  }

  .workoutDel:hover{
    transform: translateY(-1px);
    box-shadow: 0 10px 22px rgba(0,0,0,.22);
  }

  .dateBtn:hover{
    border-color: rgba(255,255,255,.22);
    background: rgba(255,255,255,.03);
  }
}

/* press (tap/click) — работает и на мобиле */
.btn:active,
.iconbtn:active,
.tab:active,
.pill:active,
.chip:active,
.workoutCard:active,
.workoutDel:active,
.toastBtn:active,
.dateBtn:active{
  transform: scale(.98);
  opacity: .95;
}

/* focus для клавиатуры (не мешает тачу) */
.btn:focus-visible,
.iconbtn:focus-visible,
.tab:focus-visible,
.pill:focus-visible,
.chip:focus-visible,
.workoutCard:focus-visible,
.workoutDel:focus-visible,
.toastBtn:focus-visible,
.dateBtn:focus-visible,
input:focus-visible,
select:focus-visible,
textarea:focus-visible{
  outline: none;
  box-shadow: 0 0 0 3px rgba(77,163,255,.28);
}

[data-theme="pink"] .btn:focus-visible,
[data-theme="pink"] .iconbtn:focus-visible,
[data-theme="pink"] .tab:focus-visible,
[data-theme="pink"] .pill:focus-visible,
[data-theme="pink"] .chip:focus-visible,
[data-theme="pink"] .workoutCard:focus-visible,
[data-theme="pink"] .workoutDel:focus-visible,
[data-theme="pink"] .toastBtn:focus-visible,
[data-theme="pink"] .dateBtn:focus-visible,
[data-theme="pink"] input:focus-visible,
[data-theme="pink"] select:focus-visible,
[data-theme="pink"] textarea:focus-visible{
  box-shadow: 0 0 0 3px rgba(255,95,191,.20);
}

/* inputs — лёгкая подсветка при фокусе */
input:focus, select:focus, textarea:focus{
  border-color: rgba(255,255,255,.22);
  background: rgba(255,255,255,.03);
}
[data-theme="pink"] input:focus,
[data-theme="pink"] select:focus,
[data-theme="pink"] textarea:focus{
  border-color: rgba(255,62,168,.26);
  background: rgba(255,62,168,.06);
}

/* активный tab — чуть "приподнять" */
.tab.active{
  transition:
    transform var(--dur) var(--ease),
    background-color var(--dur) var(--ease),
    border-color var(--dur) var(--ease),
    color var(--dur) var(--ease);
}
.tab.active{
  transform: translateY(-1px);
}

</style>


  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-FLL51E9PX7"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-FLL51E9PX7');
</script>
  
</head>

<body>
  <div class="wrap" id="app">
    <div class="topbar">
      <div class="brand">
        <div class="logo">WT</div>
        <div class="title">
          <b>Tracker</b>
          <span id="sub">Вход</span>
        </div>
      </div>




<!-- BOOT (единственный лоадер) -->
<div id="screenBoot" class="loadingScreen" style="display:none;">
  <div class="loadingInner">
    <div class="spinner" aria-hidden="true"></div>
    <div class="loadingText">Проверяю вход…</div>
  </div>
</div>

      <div class="right">
        <div class="switch">
          <span>Black</span>
          <div class="toggle" id="themeToggle" title="Переключить тему">
            <div class="knob"></div>
          </div>
          <span>Pink</span>
        </div>
        <button class="iconbtn" id="logoutBtn" title="Выйти" style="display:none;">⎋</button>
      </div>
    </div>

    <!-- LOGIN -->
        <div id="screenLogin" class="card" style="display:none;">
        <h2>Вход</h2>
   <!--   <div class="muted">Вход по никнейму и паролю. Доступ только 2 пользователям.</div> -->

      <label>Никнейм</label>
      <input id="nick" placeholder="nickname" />

      <label>Пароль</label>
      <input id="pass" type="password" placeholder="••••••••" />

    <!--  <div id="loginHint" class="alert">
        Пример: nick = <b>gorilla</b> или <b>girl</b>
      </div> -->

      <div class="actions">
        <button class="btn primary" id="loginBtn">Войти</button>
      </div>
    </div>

    <!-- APP -->
    <div id="screenApp" style="display:none;">
      <div class="tabs">
        <div class="tab active" data-tab="dashboard">Главная</div>
        <div class="tab" data-tab="select">Тренировки</div>
        <div class="tab" data-tab="history">История</div>
        <div class="tab" data-tab="progress">Прогресс</div>
        <div class="tab" data-tab="admin" id="adminTabBtn" style="display:none;">Админ</div>
      </div>

<!-- DASHBOARD -->
<div id="tab-dashboard" class="tabpane">
  <div class="card">
    <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:10px">
      <div>
        <div class="muted">Профиль</div>
        <div style="font-size:20px;font-weight:900;margin-top:2px" id="profileName">—</div>
        <div class="muted" id="today"></div>
      </div>
    </div>

    <div class="kpi">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:800;font-size:14px">Эта неделя</div>
        <div class="muted" id="monthStat">0 тренировок</div>
      </div>
      <div class="bar"><div id="monthBar"></div></div>
      <div class="muted" style="margin-top:8px">План = 3 тренировки/неделю.</div>
    </div>

    <div class="actions">
      <button class="btn primary" id="goStart">Начать тренировку</button>
      <div class="two">
        <button class="btn secondary" id="goHistory">История</button>
        <button class="btn secondary" id="goProgress">Прогресс</button>
      </div>
    </div>
  </div>

  <div class="card">
    <div style="font-weight:900;margin-bottom:8px">Последняя тренировка</div>
    <div id="lastWorkout" class="muted">Пока нет записей.</div>
  </div>

  <!-- BODY (только на главной) -->
  <div class="card">
    <h2>Тело</h2>
    <div class="muted">Рекомендуется делать запись 1 раз в неделю.</div>

<div class="row" style="margin-top:10px">
  <div>
    <label>Дата</label>
    <div class="dateWrap">
      <button type="button" class="dateBtn" id="bodyDateBtn">—</button>
      <input id="bodyDate" type="date" class="dateNative" />
    </div>
  </div>

  <div>
    <label>Вес (кг)</label>
    <input id="bodyWeight" type="number" step="0.1" placeholder="например 60.5" />
  </div>
</div>




    <div style="font-weight:900;margin-top:12px">Параметры (см)</div>
<div class="row" style="margin-top:8px">
  <div>
    <label>Грудь</label>
    <input id="bodyChest" type="number" step="0.1" placeholder="например 92" />
  </div>
  <div>
    <label>Бицепс</label>
    <input id="bodyBiceps" type="number" step="0.1" placeholder="например 32" />
  </div>
</div>

<div class="row" style="margin-top:8px">
  <div>
    <label>Талия</label>
    <input id="bodyWaist" type="number" step="0.1" placeholder="например 68" />
  </div>
  <div>
    <label>Бёдра</label>
    <input id="bodyHips" type="number" step="0.1" placeholder="например 96" />
  </div>
</div>

    <div class="actions" style="margin-top:12px">
      <button class="btn primary" id="bodySaveBtn">Сохранить</button>
      <button class="btn secondary" id="bodyClearBtn">Очистить все записи</button>
    </div>

<div style="margin-top:12px; height:220px;">
  <canvas id="bodyWeightChart" style="width:100%; height:100%; display:block;"></canvas>
</div>

    <div style="font-weight:900;margin-top:14px">Прогресс параметров</div>
    <div id="bodyMeasTableWrap" class="muted" style="margin-top:10px">Пока нет данных.</div>
  </div>
</div>


      <!-- SELECT -->
      <div id="tab-select" class="tabpane" style="display:none;">
        <div class="card">
          <h2>Выбор тренировки</h2>
          <div class="muted">Тапни по карточке, чтобы открыть упражнения.</div>
        </div>

<div class="grid3" id="workoutList"></div>
      </div>

      <!-- WORKOUT -->
      <div id="tab-workout" class="tabpane" style="display:none;">
        <div class="card">
          <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:10px">
            <div>
              <div class="muted">Тренировка</div>
              <div style="font-size:18px;font-weight:900" id="wName">—</div>
              <div class="muted">Дата: <span id="wDate"></span></div>
            </div>
            <button class="btn secondary" id="finishBtn" style="width:auto;padding:10px 12px">Завершить</button>
          </div>
        </div>

        <div class="card">
          <div style="font-weight:900;margin-bottom:10px">Упражнения</div>
          <div id="exPills"></div>
        </div>

        <div class="card">
<div style="display:flex;align-items:flex-start;justify-content:space-between;gap:10px">
  <div>
    <div style="font-size:16px;font-weight:900" id="exTitle">—</div>
    <div class="muted">План: <span id="exScheme">—</span></div>
  </div>

  <div style="display:flex; gap:8px; align-items:center;">
    <button class="btn secondary" id="videoBtn" style="width:auto;padding:10px 12px">Видео</button>
    <button class="btn secondary" id="machineBtn" style="width:auto;padding:10px 12px; display:none;">Тренажёр</button>
  </div>
</div>

          <label>Примечание</label>
          <textarea id="exNote" rows="3" placeholder="Например: следи за техникой"></textarea>
          <div class="noteHint">Сохраняется для упражнения навсегда</div>

          <div class="kpi" style="margin-top:12px">
            <div class="row">
              <div>
                <label>Подход №</label>
                <input id="setNo" type="number" min="1" value="1" />
              </div>
              <div>
                <label>Вес (кг)</label>
                <input id="weight" type="number" step="0.5" value="0" />
              </div>
              <div>
                <label>Повторы</label>
                <input id="reps" type="number" min="0" value="12" />
              </div>
            </div>

            <div class="divider"></div>
<div style="font-weight:900; font-size:13px;">Быстрое добавление веса</div>
<div class="muted" style="margin-top:6px;">
  Нажимай сколько угодно раз — сумма накапливается и применится при сохранении.
</div>

<div class="chips" id="quickChips">
  <div class="chip" data-add="2.5">+2.5</div>
  <div class="chip" data-add="5">+5</div>
  <div class="chip" data-add="10">+10</div>
</div>

<div style="margin-top:10px; display:flex; align-items:center; justify-content:space-between; gap:10px;">
  <div class="muted" style="font-weight:900;">
    Добавить: <span id="deltaTxt" class="deltaBig">+0</span> кг
  </div>
  <button class="btn secondary" id="clearDeltaBtn" style="width:auto; padding:10px 12px;">Сброс</button>
</div>

            <div class="actions" style="margin-top:10px">
              <button class="btn primary" id="saveSet">Сохранить подход</button>
              <div class="muted">Сохранение идёт в Firestore после «Завершить».</div>
            </div>
          </div>

<div class="prevBox" id="prevBox" style="display:none;">
  <div class="prevTitle">Предыдущая тренировка по упражнению</div>
  <div class="muted" id="prevMeta" style="margin-top:4px;"></div>
  <div class="prevGrid" id="prevGrid"></div>
</div>

          <div style="font-weight:900;margin-top:14px">Текущие подходы</div>
          <div id="setsTableWrap" style="margin-top:10px" class="muted">Пока нет подходов.</div>
        </div>
      </div>

      <!-- HISTORY -->
      <div id="tab-history" class="tabpane" style="display:none;">
        <div class="card">
          <h2>История</h2>
          <div class="muted">Тренировки по датам. Экспорт — по месяцам.</div>

          <label>Месяц для экспорта</label>
          <select id="monthSelect"></select>

          <div class="actions">
            <button class="btn secondary" id="exportXlsx">Export XLSX (Workouts + Body + Notes)</button>
          </div>
        </div>
        <div id="historyList"></div>
      </div>

      <!-- PROGRESS -->
      <div id="tab-progress" class="tabpane" style="display:none;">
        <div class="card">
          <h2>Прогресс</h2>
          <div class="muted">Сравнение: последняя тренировка vs предыдущая по каждому упражнению.</div>
        </div>
        <div class="card" id="progressTableWrap"></div>
      </div>

      <!-- ADMIN -->
      <div id="tab-admin" class="tabpane" style="display:none;">
        <div class="card">
          <h2>Админ</h2>
          <div class="muted">Редактирование программ пользователей (users/{uid}/config/program).</div>

          <label>Пользователь</label>
          <select id="adminUserSelect">
            <option value="TJ4cLJ0pVgb0dkh2R6IDdDS8k6F2">Личный</option>
            <option value="8Jbaay5imHYxRfEuL7hpRVIKAhW2">Софа</option>
          </select>

          <div class="actions">
            <div class="two">
              <button class="btn secondary" id="adminLoadBtn">Загрузить</button>
              <button class="btn secondary" id="adminCopyDefaultBtn">Скопировать дефолт</button>
            </div>
            <button class="btn primary" id="adminSaveBtn">Сохранить</button>
          </div>

          <label style="margin-top:12px;">Program JSON</label>
          <textarea id="adminProgramJson" rows="16"></textarea>

          <div class="alert" id="adminStatus" style="display:none;"></div>
        </div>
      </div>

    </div>
  </div>


  <!-- Chart.js (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";

  import {
    getAuth,
    signInWithEmailAndPassword,
    signOut,
    setPersistence,
    browserLocalPersistence,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

  import {
    getFirestore,
    doc,
    getDoc,
    setDoc,
    collection,
    addDoc,
    getDocs,
    query,
    orderBy,
    deleteDoc,
    writeBatch
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // ---------------------------
  // Firebase
  // ---------------------------
  const firebaseConfig = {
    apiKey: "AIzaSyCDV7oyY707TGZpaaBbKfgZvpAJ8mZ8QdM",
    authDomain: "workout-tracker-95212121.firebaseapp.com",
    projectId: "workout-tracker-95212121",
    storageBucket: "workout-tracker-95212121.firebasestorage.app",
    messagingSenderId: "105737690348",
    appId: "1:105737690348:web:d9938bca38e0ab4eab59c9"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // ---------------------------
  // Access
  // ---------------------------
  const NICK_TO_EMAIL = {
    gorilla: "gorilla@app.local",
    miu_miu: "girl@app.local"
  };

  const ADMIN_UID = "TJ4cLJ0pVgb0dkh2R6IDdDS8k6F2";
  function isAdminLocal() {
    return !!user && user.uid === ADMIN_UID;
  }

  // ---------------------------
  // Default program
  // ---------------------------
  const DEFAULT_PROGRAM = {
    "Вверх": [
      { name: "Тяга верхнего блока / гравитрон", scheme: "4×15 | 12", video: "https://drive.google.com/" },
      { name: "Бабочка", scheme: "4×12 | 10", video: "https://drive.google.com/" },
      { name: "Жим гантелей сидя / стоя", scheme: "4×12", video: "https://drive.google.com/" },
      { name: "Отжимания обратным хватом", scheme: "3×max", video: "https://drive.google.com/" },
      { name: "Сгибание гантелей стоя", scheme: "3×12", video: "https://drive.google.com/" }
    ],
    "Ягодицы": [
      { name: "Разгиб сидя в тренажёре", scheme: "3×15", video: "https://drive.google.com/" },
      { name: "Присед в Смите", scheme: "5×12 | 10", video: "https://drive.google.com/" },
      { name: "Ягодичный мостик (штанга)", scheme: "4×12 | 10", video: "https://drive.google.com/" },
      { name: "Румынская тяга", scheme: "4×12 | 10", video: "https://drive.google.com/" },
      { name: "Выпады в Смите (обычные)", scheme: "3×10 на ногу", video: "https://drive.google.com/" }
    ],
    "Ноги": [
      { name: "Разгиб сидя в тренажёре", scheme: "3×15", video: "https://drive.google.com/" },
      { name: "Присед в Смите (средняя / узкая стойка)", scheme: "5×12 | 10", video: "https://drive.google.com/" },
      { name: "Жим ногами в платформе", scheme: "4×10", video: "https://drive.google.com/" },
      { name: "Сгибание ног сидя", scheme: "4×12 | 10", video: "https://drive.google.com/" }
    ]
  };

  let PROGRAM = DEFAULT_PROGRAM;

  // ---------------------------
  // State
  // ---------------------------
  let user = null;           // Firebase user
  let profile = null;        // {nick}
  let history = [];          // sessions
  let activeTab = "dashboard";

  let currentWorkout = null;
  let currentExercise = null;
  let session = { date: todayISO(), workout: null, items: {} }; // items[exName] = sets[]
  let EX_NOTES = {}; // { [exerciseName]: string }
  let EX_NOTES_UPDATED_AT = null;
  let exNoteSaveTimer = null;

  // ---------------------------
// Helpers
// ---------------------------
function el(id) { return document.getElementById(id); }
function haptic() {
  // best-effort: на iOS PWA чаще всего 0 эффекта, но на Android/десктопе бывает
  try { if (navigator.vibrate) navigator.vibrate(10); } catch(e) {}
}

function confirmDelete(text) {
  haptic();
  return confirm(text);
}
// ---------------------------
// Quick add weight (delta)
// ---------------------------
let deltaAdd = 0;

function setDeltaAdd(v) {
  deltaAdd = Math.round(v * 10) / 10;
  const t = el("deltaTxt");
  if (t) t.textContent = (deltaAdd >= 0 ? "+" : "") + deltaAdd;
}

function addDelta(x) {
  setDeltaAdd(deltaAdd + x);
}

el("quickChips")?.addEventListener("click", (e) => {
  const chip = e.target.closest(".chip");
  if (!chip) return;
  haptic();

  const add = Number(chip.dataset.add || 0);
  if (!Number.isFinite(add) || add <= 0) return;

  addDelta(add);

  chip.classList.add("on");
  setTimeout(() => chip.classList.remove("on"), 120);
});

el("clearDeltaBtn")?.addEventListener("click", () => {
  haptic();
  setDeltaAdd(0);
});

// init
setDeltaAdd(0);

/* --- Undo toast (5s) --- */
let undoTimer = null;
let undoPayload = null;

function showUndoToast(message, payload) {
  const toast = el("toast");
  if (!toast) return;

  el("toastMsg").textContent = message;
  toast.style.display = "";

  undoPayload = payload;

  if (undoTimer) clearTimeout(undoTimer);
  undoTimer = setTimeout(() => {
    toast.style.display = "none";
    undoPayload = null;
  }, 5000);
}

el("toastUndoBtn")?.addEventListener("click", () => {
  haptic();
  if (!undoPayload) return;
  undoPayload.undo();
  undoPayload = null;
  el("toast").style.display = "none";
  if (undoTimer) clearTimeout(undoTimer);
});

function show(id, yes = true) {
  const n = el(id);
  if (!n) return;
  n.style.display = yes ? "" : "none";
}

function setSub(txt) {
  const n = el("sub");
  if (n) n.textContent = txt;
}

// LOADING helper
function setLoading(on, text = "Загрузка") {
  const scr = el("screenBoot"); // ✅ было screenLoading
  if (scr) scr.style.display = on ? "" : "none";

  const t = scr?.querySelector?.(".loadingText");
  if (t) t.textContent = text;

  document.body.style.overflow = on ? "hidden" : "";
}

function adminMsg(text, isError = false) {
  const box = el("adminStatus");
  if (!box) return;
  box.style.display = "";
  box.innerHTML = isError ? `<b>Ошибка:</b> ${text}` : text;
}

function todayISO() {
  const d = new Date();
  const tz = d.getTimezoneOffset() * 60000;
  return new Date(Date.now() - tz).toISOString().slice(0, 10);
}

function fmt(iso) {
  const [y, m, d] = iso.split("-");
  return `${d}.${m}.${y}`;
}

function monthKey(iso) { return iso.slice(0, 7); } // YYYY-MM
function monthTitle(ym) {
  const [y, m] = ym.split("-");
  return `${m}.${y}`;
}

function toNumOrNull(v) {
  if (v === "" || v === null || v === undefined) return null;
  const n = Number(v);
  return Number.isFinite(n) ? n : null;
}

  // ---------------------------
// Body by DATE (Firestore): users/{uid}/bodyWeekly/{dateISO}
// (коллекцию оставили bodyWeekly, но теперь docId = YYYY-MM-DD)
// ---------------------------
let bodyWeeklyMap = {}; // { dateISO: { weight, chest, biceps, waist, hips, updatedAt } }

function fmtISO(iso) {
  const [y, m, d] = iso.split("-");
  return `${d}.${m}.${y}`;
}

function numTxt(v) {
  if (v === null || v === undefined) return "—";
  const s = Number(v).toFixed(1);
  return s.replace(/\.0$/, "");
}

function deltaCell(curr, prev) {
  if (curr === null || curr === undefined) return `<span class="delta eq">—</span>`;
  if (prev === null || prev === undefined) return `<span class="delta eq">—</span>`;
  const d = Number(curr) - Number(prev);
  if (!Number.isFinite(d) || d === 0) return `<span class="delta eq">0</span>`;
  const abs = Math.abs(d).toFixed(1).replace(/\.0$/, "");
  if (d < 0) return `<span class="delta down">-${abs}</span>`;
  return `<span class="delta up">+${abs}</span>`;
}

async function loadBodyWeekly() {
  if (!user) return;
  bodyWeeklyMap = {};
  const snap = await getDocs(collection(db, "users", user.uid, "bodyWeekly"));
  snap.forEach(d => {
    bodyWeeklyMap[d.id] = d.data() || {};
  });
}

async function upsertBodyWeekly(dateISO, payload) {
  if (!user) return;

  // не затираем null-ами
  const cleaned = {};
  for (const [k, v] of Object.entries(payload)) {
    if (typeof v === "number") cleaned[k] = v;
  }

  if (!Object.keys(cleaned).length) {
    alert("Заполни вес и/или параметры.");
    return;
  }

  const prev = bodyWeeklyMap[dateISO] || {};
  const next = { ...prev, ...cleaned, updatedAt: Date.now() };

  // ✅ ключ документа = выбранная дата
  await setDoc(doc(db, "users", user.uid, "bodyWeekly", dateISO), next, { merge: true });
  bodyWeeklyMap[dateISO] = next;
}

async function clearBodyWeeklyAll() {
  if (!user) return;

  const ok = confirm("Очистить все записи веса и параметров?");
  if (!ok) return;

  const col = collection(db, "users", user.uid, "bodyWeekly");
  const snap = await getDocs(col);

  const batch = writeBatch(db);
  snap.forEach(d => {
    batch.delete(doc(db, "users", user.uid, "bodyWeekly", d.id));
  });
  await batch.commit();

  bodyWeeklyMap = {};
}

// ✅ delete one DATE row (one doc)
async function deleteBodyWeeklyByMonday(dateISO) {
  if (!user) return;

  const ok = confirm(`Удалить запись за ${fmtISO(dateISO)}?`);
  if (!ok) return;

  try {
    await deleteDoc(doc(db, "users", user.uid, "bodyWeekly", dateISO));
    delete bodyWeeklyMap[dateISO];

    renderBodyWeightChart();
    renderBodyMeasTable();
  } catch (e) {
    console.error(e);
    alert("Не удалось удалить запись. Проверь Rules/доступ.");
  }
}

  // ---------------------------
  // Body weekly UI (guarded)
  // ---------------------------
  let bodyChart = null;
  let bodyUIInited = false;

  function renderBodyWeightChart() {
    const keys = Object.keys(bodyWeeklyMap).sort(); // monday ISO asc
    const labels = keys.map(k => fmtISO(k));
    const data = keys.map(k => {
      const w = bodyWeeklyMap[k]?.weight;
      return (typeof w === "number") ? w : null;
    });

    const canvas = el("bodyWeightChart");
    if (!canvas) return;

    const ChartRef = window.Chart;
    if (!ChartRef) return;

    const ctx = canvas.getContext("2d");
    if (bodyChart) bodyChart.destroy();

    bodyChart = new ChartRef(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [{
          label: "Вес (кг)",
          data,
          tension: 0.25,
          pointRadius: 4,
          pointHoverRadius: 6,
          spanGaps: true,
          borderColor: themeLineColor(),
          pointBackgroundColor: themeLineColor(),
          pointBorderColor: themeLineColor()
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { labels: { color: "#ffffff" } },
          tooltip: { enabled: true }
        },
        scales: {
          x: { ticks: { color: "rgba(255,255,255,.70)" }, grid: { color: "rgba(255,255,255,.08)" } },
          y: { ticks: { color: "rgba(255,255,255,.70)" }, grid: { color: "rgba(255,255,255,.08)" } }
        }
      }
    });
  }

  function themeLineColor() {
    const isPink = document.documentElement.getAttribute("data-theme") === "pink";

    // black theme → синий
    if (!isPink) return "#4da3ff";

    // pink theme → текущий акцент
    const root = document.documentElement;
    const c = getComputedStyle(root).getPropertyValue("--btn").trim();
    return c || "#dd77af";
  }

  function renderBodyMeasTable() {
  const wrap = el("bodyMeasTableWrap");
  if (!wrap) return;

  const keys = Object.keys(bodyWeeklyMap).sort(); // asc
  if (!keys.length) {
    wrap.className = "muted";
    wrap.textContent = "Пока нет данных.";
    return;
  }

  const deltaByKey = {};
  for (let i = 0; i < keys.length; i++) {
    const k = keys[i];
    const curr = bodyWeeklyMap[k] || {};
    const prev = bodyWeeklyMap[keys[i - 1]] || {};

    deltaByKey[k] = {
      weight: deltaCell(curr.weight, prev.weight),
      chest:  deltaCell(curr.chest,  prev.chest),
      biceps: deltaCell(curr.biceps, prev.biceps),
      waist:  deltaCell(curr.waist,  prev.waist),
      hips:   deltaCell(curr.hips,   prev.hips)
    };
  }

  const showKeys = keys.slice().reverse().slice(0, 3);

  wrap.className = "";
  wrap.innerHTML = `
    <div class="vtable">
      ${showKeys.map(k => {
        const v = bodyWeeklyMap[k] || {};
        const d = deltaByKey[k] || {};
        return `
          <div class="vrow" data-week="${k}">
            <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
              <div class="vdate">${fmtISO(k)}</div>
              <button type="button" class="btn secondary" data-act="delBodyDate"
                style="width:auto;padding:8px 10px;border-radius:12px;font-size:12px;border-color:rgba(255,107,107,.45);color:var(--danger)">
                Удалить
              </button>
            </div>

            <div class="vgrid">
              <div class="vitem">
                <div class="vlabel">Вес</div>
                <div class="vvalue">${numTxt(v.weight)} кг</div>
                <div>${d.weight || `<span class="delta eq">—</span>`}</div>
              </div>

              <div class="vitem">
                <div class="vlabel">Грудь</div>
                <div class="vvalue">${numTxt(v.chest)}</div>
                <div>${d.chest || `<span class="delta eq">—</span>`}</div>
              </div>

              <div class="vitem">
                <div class="vlabel">Бицепс</div>
                <div class="vvalue">${numTxt(v.biceps)}</div>
                <div>${d.biceps || `<span class="delta eq">—</span>`}</div>
              </div>

              <div class="vitem">
                <div class="vlabel">Талия</div>
                <div class="vvalue">${numTxt(v.waist)}</div>
                <div>${d.waist || `<span class="delta eq">—</span>`}</div>
              </div>

              <div class="vitem">
                <div class="vlabel">Бёдра</div>
                <div class="vvalue">${numTxt(v.hips)}</div>
                <div>${d.hips || `<span class="delta eq">—</span>`}</div>
              </div>
            </div>
          </div>
        `;
      }).join("")}
    </div>
  `;
}
  function initBodyUI() {
  // обработчики навешиваются 1 раз
  if (bodyUIInited) return;
  bodyUIInited = true;

  if (el("bodyDate")) el("bodyDate").value = todayISO();


  // --- Date button text (input лежит поверх кнопки, клики не нужны) ---
  function updateBodyDateBtn() {
    const d = el("bodyDate")?.value || todayISO();
    const b = el("bodyDateBtn");
    if (b) b.textContent = fmtISO(d);
  }

  updateBodyDateBtn();
  el("bodyDate")?.addEventListener("change", updateBodyDateBtn);

  el("bodyDateBtn")?.addEventListener("click", () => {
  const inp = el("bodyDate");
  if (!inp) return;
  inp.showPicker?.();
  inp.focus();
});

  el("bodySaveBtn")?.addEventListener("click", async () => {
    const dateISO = el("bodyDate")?.value || todayISO();

    const payload = {
      weight: toNumOrNull(el("bodyWeight")?.value),
      chest:  toNumOrNull(el("bodyChest")?.value),
      biceps: toNumOrNull(el("bodyBiceps")?.value),
      waist:  toNumOrNull(el("bodyWaist")?.value),
      hips:   toNumOrNull(el("bodyHips")?.value)
    };

    await upsertBodyWeekly(dateISO, payload);

    if (el("bodyWeight")) el("bodyWeight").value = "";
    if (el("bodyChest")) el("bodyChest").value = "";
    if (el("bodyWaist")) el("bodyWaist").value = "";
    if (el("bodyHips")) el("bodyHips").value = "";
    if (el("bodyBiceps")) el("bodyBiceps").value = "";

    renderBodyWeightChart();
    renderBodyMeasTable();
  });

  el("bodyClearBtn")?.addEventListener("click", async () => {
    await clearBodyWeeklyAll();
    renderBodyWeightChart();
    renderBodyMeasTable();
  });

  el("bodyMeasTableWrap")?.addEventListener("click", async (e) => {
    const btn = e.target?.closest?.('button[data-act="delBodyDate"]');
    if (!btn) return;

    const row = btn.closest("[data-week]");
    const dateISO = row?.dataset?.week;
    if (!dateISO) return;

    await deleteBodyWeeklyByMonday(dateISO);
  });


}

  // ---------------------------
  // Draft workout (persist unfinished session)
  // ---------------------------
  function draftKey() {
    return user ? `wt_draft_${user.uid}` : "wt_draft_anon";
  }

  function saveDraft() {
    if (!user) return;
    if (!session || !session.workout) return;

    const payload = {
      v: 1,
      savedAt: Date.now(),
      session,
      currentWorkout,
      currentExercise
    };

    try {
      localStorage.setItem(draftKey(), JSON.stringify(payload));
    } catch (e) {
      console.warn("Draft save failed", e);
    }

    updateGoStartButton();
  }

  function loadDraft() {
    if (!user) return null;
    try {
      const raw = localStorage.getItem(draftKey());
      if (!raw) return null;
      const parsed = JSON.parse(raw);
      if (!parsed?.session?.workout) return null;
      return parsed;
    } catch (e) {
      console.warn("Draft load failed", e);
      return null;
    }
  }

  function clearDraft() {
    if (!user) return;
    try { localStorage.removeItem(draftKey()); } catch (e) { }
    updateGoStartButton();
  }

  function hasDraft() {
    const d = loadDraft();
    return !!(d && d.session && d.session.workout);
  }

  function updateGoStartButton() {
    const btn = el("goStart");
    if (!btn) return;
    btn.textContent = hasDraft() ? "Продолжить тренировку" : "Начать тренировку";
  }

  function resumeFromDraft(draft) {
    if (!draft?.session?.workout) return;

    session = draft.session;
    currentWorkout = draft.currentWorkout || session.workout;
    currentExercise = draft.currentExercise || null;

    el("wName").textContent = session.workout;
    el("wDate").textContent = fmt(session.date);

    const pills = el("exPills");
    pills.innerHTML = "";

    const list = PROGRAM[session.workout] || [];
    list.forEach((ex) => {
      const b = document.createElement("button");
      b.className = "pill";
      b.textContent = ex.name;
      b.addEventListener("click", () => selectExercise(ex.name));
      pills.appendChild(b);
    });

    if (!currentExercise || !list.some(x => x.name === currentExercise)) {
      currentExercise = list[0]?.name || null;
    }

    document.querySelectorAll("#exPills .pill").forEach(p => {
      p.classList.toggle("active", p.textContent === currentExercise);
    });

    renderExercise(true);
    setActiveTabUI("workout");
    updateGoStartButton();
  }

  window.addEventListener("beforeunload", () => {
    if (user && session?.workout) saveDraft();
  });

  // ---------------------------
  // Theme
  // ---------------------------
  const savedTheme = localStorage.getItem("wt_theme");
  if (savedTheme === "pink") document.documentElement.setAttribute("data-theme", "pink");

  el("themeToggle")?.addEventListener("click", () => {
    const isPink = document.documentElement.getAttribute("data-theme") === "pink";
    if (isPink) {
      document.documentElement.removeAttribute("data-theme");
      localStorage.setItem("wt_theme", "black");
    } else {
      document.documentElement.setAttribute("data-theme", "pink");
      localStorage.setItem("wt_theme", "pink");
    }
      renderBodyWeightChart(); // обновить цвет линии

  });

  // ---------------------------
  // Firestore: program
  // ---------------------------
  async function loadProgramDoc(uid) {
    const ref = doc(db, "users", uid, "config", "program");
    const snap = await getDoc(ref);
    if (!snap.exists()) return null;
    const data = snap.data();
    return data?.program || null;
  }

  async function saveProgramDoc(uid, programObj) {
    const ref = doc(db, "users", uid, "config", "program");
    await setDoc(ref, {
      program: programObj,
      updatedAt: Date.now(),
      updatedBy: user.uid
    }); // без merge
  }

  function validateProgramShape(p) {
    if (!p || typeof p !== "object" || Array.isArray(p)) return "Program должен быть объектом";

    const keys = Object.keys(p);
    if (!keys.length) return "Program пустой";

    for (const wName of keys) {
      if (!Array.isArray(p[wName])) return `Тренировка "${wName}" должна быть массивом упражнений`;

      for (const ex of p[wName]) {
        if (!ex || typeof ex !== "object") return `В "${wName}" есть не-объект`;
        if (!ex.name || !ex.scheme) return `В "${wName}" у упражнения нет name/scheme`;
        if (!ex.video) ex.video = "https://drive.google.com/";
        if (!ex.machine) ex.machine = "";
      }
    }
    return null;
  }

  // ---------------------------
  // Firestore: exercise notes (persistent)
  // ---------------------------
  async function loadExerciseNotes() {
    if (!user) return;
    const ref = doc(db, "users", user.uid, "config", "exerciseNotes");
    const snap = await getDoc(ref);
    if (!snap.exists()) {
      EX_NOTES = {};
      EX_NOTES_UPDATED_AT = null;
      return;
    }
    const data = snap.data() || {};
    EX_NOTES = (data.notes && typeof data.notes === "object") ? data.notes : {};
    EX_NOTES_UPDATED_AT = data.updatedAt || null;
  }

  function scheduleSaveExerciseNote(exName, noteText) {
    if (exNoteSaveTimer) clearTimeout(exNoteSaveTimer);
    exNoteSaveTimer = setTimeout(() => {
      saveExerciseNote(exName, noteText);
    }, 500);
  }

  async function saveExerciseNote(exName, noteText) {
    if (!user || !exName) return;
    const text = String(noteText ?? "");
    if (text === "") delete EX_NOTES[exName];
    else EX_NOTES[exName] = text;

    EX_NOTES_UPDATED_AT = Date.now();

    const ref = doc(db, "users", user.uid, "config", "exerciseNotes");
    await setDoc(ref, {
      notes: { ...EX_NOTES },
      updatedAt: EX_NOTES_UPDATED_AT
    }, { merge: true });
  }

  // ---------------------------
  // Tabs
  // ---------------------------
  const TABS = ["dashboard", "select", "workout", "history", "progress", "admin"];

  function setActiveTabUI(tab) {
    activeTab = tab;

    document.querySelectorAll(".tab").forEach(t => {
      t.classList.toggle("active", t.dataset.tab === tab);
    });

    TABS.forEach(k => {
      const pane = el("tab-" + k);
      if (pane) pane.style.display = (k === tab) ? "" : "none";
    });

    // если вес/параметры размещены на дашборде — перерисуем при заходе
    if (tab === "dashboard") {
      renderBodyWeightChart();
      renderBodyMeasTable();
    }
  }

  document.querySelectorAll(".tab").forEach(t => {
    t.addEventListener("click", () => {
      const tab = t.dataset.tab;

      if (tab === "admin") {
        if (!isAdminLocal()) return;
        setActiveTabUI("admin");
        return;
      }

      if (tab === "history") { setActiveTabUI("history"); renderHistory(); return; }
      if (tab === "progress") { setActiveTabUI("progress"); renderProgress(); return; }
      if (tab === "select") { setActiveTabUI("select"); renderWorkoutSelect(); return; }
      if (tab === "dashboard") { setActiveTabUI("dashboard"); renderDashboard(); return; }
      if (tab === "workout") { setActiveTabUI("workout"); return; }
    });
  });

  el("goStart")?.addEventListener("click", () => {
    const d = loadDraft();
    if (d) {
      resumeFromDraft(d);
      return;
    }
    setActiveTabUI("select");
    renderWorkoutSelect();
  });

  el("goHistory")?.addEventListener("click", () => { setActiveTabUI("history"); renderHistory(); });
  el("goProgress")?.addEventListener("click", () => { setActiveTabUI("progress"); renderProgress(); });

  // ---------------------------
  // Load sessions
  // ---------------------------
  async function loadHistory() {
    if (!user) return;
    const qy = query(collection(db, "users", user.uid, "sessions"), orderBy("date", "desc"));
    const snap = await getDocs(qy);
    history = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  }

  async function deleteSessionById(sessionId) {
    if (!user) return;

    const ok = confirm("Удалить эту тренировку? Действие нельзя отменить.");
    if (!ok) return;

    try {
      await deleteDoc(doc(db, "users", user.uid, "sessions", sessionId));

      await loadHistory();
      await loadBodyWeekly();

      renderWorkoutSelect();
      renderDashboard();
      renderHistory();
      renderProgress();

      // ВАЖНО: initBodyUI НЕ вызываем тут (иначе будут дубли обработчиков)
      renderBodyWeightChart();
      renderBodyMeasTable();
    } catch (e) {
      console.error(e);
      alert("Не удалось удалить тренировку. Проверь доступ/Rules.");
    }
  }

  // ---------------------------
  // Workout selection
  // ---------------------------
  function workoutSubtitle(name) {
    const map = {
      "Спина / Бицепсы": "Спина / бицепсы / плечи",
      "Грудь / Трицепсы": "Грудь / трицепсы / плечи",
      "Ноги": "Ноги",
      "Вверх": "Спина / грудь / плечи / руки",
      "Ягодицы": "Акцент на ягодицы"
    };
    return map[name] || "Тренировка";
  }

  function renderWorkoutSelect() {
    const wrap = el("workoutList");
    if (!wrap) return;

    const names = Object.keys(PROGRAM || {}).filter(Boolean);

    if (!names.length) {
      wrap.innerHTML = `
        <div class="card">
          <div class="muted">Нет тренировок в программе. Добавь через Админ → Program JSON.</div>
        </div>
      `;
      return;
    }
wrap.innerHTML = names.map(name => `
  <div class="workoutCard" data-workout="${name}">
    <div class="workoutHead">
      <div class="workoutMeta">
        <h3>${name}</h3>
        <div class="muted">${workoutSubtitle(name)}</div>
      </div>
    </div>
  </div>
`).join("");
wrap.querySelectorAll(".workoutCard").forEach(card => {
  card.addEventListener("click", () => startWorkout(card.dataset.workout));
});

  }

  async function deleteWorkoutFromProgram(workoutName) {
    if (!user) return;

    const ok = confirm(`Удалить тренировку "${workoutName}" из программы?`);
    if (!ok) return;

    try {
      const next = { ...(PROGRAM || {}) };
      delete next[workoutName];

      PROGRAM = next;

      await saveProgramDoc(user.uid, PROGRAM);

      renderWorkoutSelect();

      if (currentWorkout === workoutName) {
        currentWorkout = null;
        currentExercise = null;
        session = { date: todayISO(), workout: null, items: {} };
        clearDraft();
        setActiveTabUI("select");
        renderWorkoutSelect();
      }
    } catch (err) {
      console.error(err);
      alert("Не удалось удалить тренировку. Проверь Rules/доступ.");
    }
  }

  function startWorkout(w) {
    currentWorkout = w;
    session = { date: todayISO(), workout: w, items: {} };

    el("wName").textContent = w;
    el("wDate").textContent = fmt(session.date);

    const pills = el("exPills");
    pills.innerHTML = "";

    const list = PROGRAM[w] || [];
    list.forEach((ex, i) => {
      const b = document.createElement("button");
      b.className = "pill" + (i === 0 ? " active" : "");
      b.textContent = ex.name;
      b.addEventListener("click", () => selectExercise(ex.name));
      pills.appendChild(b);
    });

    currentExercise = list[0]?.name || null;
    renderExercise(true);
    setActiveTabUI("workout");

    saveDraft();
  }

  function selectExercise(name) {
    currentExercise = name;
    document.querySelectorAll("#exPills .pill").forEach(p => {
      p.classList.toggle("active", p.textContent === name);
    });
    renderExercise(true);
    saveDraft();
  }

  function getExObj() {
    const arr = PROGRAM[currentWorkout] || [];
    return arr.find(x => x.name === currentExercise);
  }

  function isValidVideoUrl(url) {
    if (!url) return false;
    const u = String(url).trim();
    if (!u || u === "-") return false;
    return /^https?:\/\//i.test(u);
  }

function renderExercise(resetSetNo = false) {
  const ex = getExObj();
  if (!ex) {
    el("exTitle").textContent = "Нет упражнений";
    el("exScheme").textContent = "—";
    el("setsTableWrap").innerHTML = "—";
    const noteEl = el("exNote");
    if (noteEl) {
      noteEl.value = "";
      noteEl.disabled = true;
    }
    renderPrevBox(); // чтобы скрыть превью
    return;
  }

  const vBtn = el("videoBtn");
  if (vBtn) vBtn.style.display = isValidVideoUrl(ex.video) ? "" : "none";

  el("exTitle").textContent = ex.name;
  el("exScheme").textContent = ex.scheme;
  const noteEl = el("exNote");
  if (noteEl) {
    noteEl.disabled = false;
    noteEl.value = EX_NOTES[ex.name] || "";
  }

  const mBtn = el("machineBtn");
  if (mBtn) {
    const has = !!(ex.machine && String(ex.machine).trim());
    mBtn.style.display = has ? "" : "none";
  }

  if (resetSetNo) {
    const sets = session.items[ex.name] || [];
    const next = sets.length ? (Math.max(...sets.map(s => Number(s.setNo || 0))) + 1) : 1;
    el("setNo").value = next;
  }

  renderSetsTable();
  renderPrevBox();
  autoFillFromPrevIfDefault();
}


  function getLastSessionForExercise(exName) {
  for (const h of (history || [])) {
    const it = (h.items || []).find(x => x.ex === exName);
    if (it && (it.sets || []).length) return { date: h.date, sets: it.sets };
  }
  return null;
}




el("setNo")?.addEventListener("change", () => {
  renderPrevBox();
  autoFillFromPrevIfDefault();
});


function renderPrevBox() {
  const ex = getExObj();
  const box = el("prevBox");
  const grid = el("prevGrid");
  const meta = el("prevMeta");
  if (!box || !grid || !meta) return;

  if (!ex) { box.style.display = "none"; return; }

  const last = getLastSessionForExercise(ex.name);
  if (!last) { box.style.display = "none"; return; }

  box.style.display = "";
  meta.textContent = `Дата: ${fmt(last.date)} • Подходов: ${(last.sets || []).length}`;

  const curSetNo = Number(el("setNo").value || 1);

  grid.innerHTML = (last.sets || []).map(s => {
    const isCur = Number(s.setNo) === curSetNo;
    return `
      <div class="prevRow ${isCur ? "current" : ""}">
        <div>Подход <b>${s.setNo}</b></div>
        <div><b>${s.weight}</b> кг × <b>${s.reps}</b></div>
      </div>
    `;
  }).join("");
}

function autoFillFromPrevIfDefault() {
  const ex = getExObj();
  if (!ex) return;

  const last = getLastSessionForExercise(ex.name);
  if (!last) return;

  const setNo = Number(el("setNo").value || 1);
  const prevSet = (last.sets || []).find(s => Number(s.setNo) === setNo);
  if (!prevSet) return;

  const w = Number(el("weight").value || 0);
  const r = Number(el("reps").value || 0);

  if (w === 0) el("weight").value = prevSet.weight;
  if (r === 12) el("reps").value = prevSet.reps;
}

el("setNo")?.addEventListener("input", () => {
  renderPrevBox();
  autoFillFromPrevIfDefault();
});

el("exNote")?.addEventListener("input", (e) => {
  if (!currentExercise) return;
  const text = String(e.target?.value ?? "");
  if (text === "") delete EX_NOTES[currentExercise];
  else EX_NOTES[currentExercise] = text;
  scheduleSaveExerciseNote(currentExercise, text);
});

  // ---------------------------
  // Video modal
  // ---------------------------
  function openVideoModal(url) {
    const modal = el("videoModal");
    const vid = el("videoPlayer");
    const err = el("videoErr");
    if (!modal || !vid || !err) return;

    err.style.display = "none";
    vid.pause();
    vid.removeAttribute("src");
    vid.load();

    vid.src = url;
    vid.onloadeddata = () => { err.style.display = "none"; };
    vid.onerror = () => { err.style.display = ""; };

    modal.style.display = "";
  }

  function closeVideoModal() {
    const modal = el("videoModal");
    const vid = el("videoPlayer");
    if (!modal || !vid) return;

    modal.style.display = "none";
    vid.pause();
    vid.removeAttribute("src");
    vid.load();
  }

  el("videoBtn")?.addEventListener("click", () => {
    const ex = getExObj();
    const url = ex?.video ? String(ex.video).trim() : "";
    if (!isValidVideoUrl(url)) return;
    openVideoModal(url);
  });
  el("videoClose")?.addEventListener("click", closeVideoModal);
  el("videoBackdrop")?.addEventListener("click", closeVideoModal);

  // ---------------------------
  // Machine modal
  // ---------------------------
  function openMachineModal(url) {
    const modal = el("machineModal");
    const img = el("machineImg");
    const err = el("machineErr");
    if (!modal || !img || !err) return;

    err.style.display = "none";
    img.onload = () => { err.style.display = "none"; };
    img.onerror = () => { err.style.display = ""; };

    img.src = url;
    modal.style.display = "";
  }

  function closeMachineModal() {
    const modal = el("machineModal");
    const img = el("machineImg");
    if (!modal || !img) return;

    modal.style.display = "none";
    img.src = "";
  }

  el("machineBtn")?.addEventListener("click", () => {
    const ex = getExObj();
    const url = ex?.machine ? String(ex.machine).trim() : "";
    if (!url) return;
    openMachineModal(url);
  });
  el("machineClose")?.addEventListener("click", closeMachineModal);
  el("machineBackdrop")?.addEventListener("click", closeMachineModal);

  window.addEventListener("keydown", (e) => {
    if (e.key === "Escape") {
      closeVideoModal();
      closeMachineModal();
    }
  });

  // ---------------------------
  // Sets: add/edit/delete (как в демо)
  // ---------------------------
el("saveSet")?.addEventListener("click", () => {
  haptic();

  const ex = getExObj();
  if (!ex) return;

  const setNo = Number(el("setNo").value || 1);

  const baseWeight = Number(el("weight").value || 0);
  const finalWeight = Math.round((baseWeight + deltaAdd) * 10) / 10;

  const reps = Number(el("reps").value || 0);

  if (!Number.isFinite(setNo) || setNo < 1) return alert("Некорректный номер подхода");
  if (!Number.isFinite(finalWeight) || finalWeight < 0) return alert("Некорректный вес");
  if (!Number.isFinite(reps) || reps < 0) return alert("Некорректные повторы");

  if (!session.items[ex.name]) session.items[ex.name] = [];
  session.items[ex.name].push({ setNo, weight: finalWeight, reps });
  session.items[ex.name].sort((a, b) => a.setNo - b.setNo);

  renderSetsTable();
  saveDraft();

  // сброс добавки после сохранения
  setDeltaAdd(0);

  // следующий номер подхода
  el("setNo").value = setNo + 1;
});

  function renderSetsTable() {
    const ex = getExObj();
    const wrap = el("setsTableWrap");
    if (!wrap) return;

    if (!ex) {
      wrap.innerHTML = `<div class="muted">—</div>`;
      return;
    }

    const sets = session.items[ex.name] || [];

    if (!sets.length) {
      wrap.className = "muted";
      wrap.innerHTML = "Пока нет подходов.";
      return;
    }

    wrap.className = "";
    wrap.innerHTML = `
      <table>
        <thead>
          <tr>
            <th>№</th><th>Вес</th><th>Повт.</th><th>Действия</th>
          </tr>
        </thead>
        <tbody>
          ${sets.map((s, idx) => `
            <tr data-idx="${idx}">
              <td>${s.setNo}</td>
              <td>${s.weight} кг</td>
              <td>${s.reps}</td>
              <td>
                <button class="btn secondary" data-act="edit" style="width:auto;padding:8px 10px;border-radius:12px;font-size:12px">Ред.</button>
                <button class="btn secondary" data-act="del" style="width:auto;padding:8px 10px;border-radius:12px;font-size:12px;border-color:rgba(255,107,107,.45);color:var(--danger)">Удалить</button>
              </td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    `;

    wrap.querySelectorAll("button").forEach(btn => {
      const tr = btn.closest("tr");
      const idx = Number(tr.dataset.idx);
      const act = btn.dataset.act;

      btn.addEventListener("click", () => {
        const ex = getExObj();
        if (!ex) return;

        const sets = session.items[ex.name] || [];
        const src = sets[idx];
        if (!src) return;

        if (act === "del") {
          sets.splice(idx, 1);
          session.items[ex.name] = sets;
          renderSetsTable();

          const next = sets.length ? (Math.max(...sets.map(s => Number(s.setNo || 0))) + 1) : 1;
          el("setNo").value = next;

          saveDraft();
          return;
        }

        if (act === "edit") {
          el("setNo").value = src.setNo;
          el("weight").value = src.weight;
          el("reps").value = src.reps;

          sets.splice(idx, 1);
          session.items[ex.name] = sets;
          renderSetsTable();

          saveDraft();
          return;
        }
      });
    });
  }

  // ---------------------------
  // Finish workout -> save to Firestore
  // ---------------------------
  el("finishBtn")?.addEventListener("click", async () => {
    if (!user || !session.workout) { setActiveTabUI("dashboard"); return; }

    const items = Object.entries(session.items).map(([ex, sets]) => ({ ex, sets }));
    const payload = {
      date: session.date,
      month: monthKey(session.date),
      workout: session.workout,
      items,
      createdAt: Date.now()
    };

    try {
      await addDoc(collection(db, "users", user.uid, "sessions"), payload);

      clearDraft();

      currentWorkout = null;
      currentExercise = null;
      session = { date: todayISO(), workout: null, items: {} };

      await loadHistory();
      renderDashboard();
      renderHistory();
      renderProgress();
      setActiveTabUI("dashboard");
    } catch (e) {
      console.error(e);
      alert("Не удалось сохранить. Проверь Rules/доступ.");
    }
  });

  // ---------------------------
  // Dashboard: 3 workouts per week
  // ---------------------------
  function weekRangeISO() {
    const now = new Date();
    const d = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const day = (d.getDay() + 6) % 7; // Monday=0..6
    const monday = new Date(d); monday.setDate(d.getDate() - day);
    const sunday = new Date(monday); sunday.setDate(monday.getDate() + 6);

    const toISO = (x) => {
      const tz = x.getTimezoneOffset() * 60000;
      return new Date(x.getTime() - tz).toISOString().slice(0, 10);
    };
    return { start: toISO(monday), end: toISO(sunday) };
  }

  function renderDashboard() {
    const todayEl = el("today");
    if (todayEl) todayEl.textContent = "Сегодня: " + fmt(todayISO());

    const GOAL_PER_WEEK = 3;
    const { start, end } = weekRangeISO();
    const count = history.filter(h => h.date >= start && h.date <= end).length;

    const stat = el("monthStat");
    if (stat) stat.textContent = `${count} / ${GOAL_PER_WEEK} тренировок`;

    const pct = Math.min(100, Math.round((count / GOAL_PER_WEEK) * 100));
    const bar = el("monthBar");
    if (bar) bar.style.width = pct + "%";

    const last = history[0];
    const lastWrap = el("lastWorkout");
    if (lastWrap) {
      if (!last) {
        lastWrap.textContent = "Пока нет записей.";
      } else {
        lastWrap.innerHTML = `
          <div style="font-weight:900">${last.workout}</div>
          <div class="muted">${fmt(last.date)} • Упражнений: ${(last.items || []).length}</div>
        `;
      }
    }

    updateGoStartButton();

    // если блок веса/параметров на главной — держим в актуале
    renderBodyWeightChart();
    renderBodyMeasTable();
  }

  // ---------------------------
  // History + export
  // ---------------------------
  function renderMonthSelect() {
    const months = Array.from(new Set(history.map(h => h.month))).sort().reverse();
    const sel = el("monthSelect");
    if (!sel) return;

    sel.innerHTML = months.map(m => `<option value="${m}">${monthTitle(m)}</option>`).join("");
    if (!months.length) {
      sel.innerHTML = `<option value="">Нет данных</option>`;
    }
  }

  function renderHistory() {
    renderMonthSelect();

    const list = el("historyList");
    if (!list) return;

    if (!history.length) {
      list.innerHTML = `<div class="card"><div class="muted">Пока нет записей.</div></div>`;
      return;
    }

    list.innerHTML = history.slice(0, 10).map(t => {
      const body = (t.items || []).map(it => {
        const line = (it.sets || []).map(s => `${s.setNo}: ${s.weight}кг×${s.reps}`).join(" • ");
        return `<div style="margin-top:10px">
          <div style="font-weight:900;font-size:13px">${it.ex}</div>
          <div class="muted" style="margin-top:2px">${line || "—"}</div>
        </div>`;
      }).join("");

      return `
        <div class="card">
          <div style="display:flex;justify-content:space-between;gap:10px;align-items:center">
            <div>
              <div style="font-weight:900">${t.workout}</div>
              <div class="muted">${fmt(t.date)}</div>
            </div>
            <button class="btn secondary delSessionBtn"
                    data-id="${t.id}"
                    style="width:auto;padding:10px 12px">
              Удалить
            </button>
          </div>
          <div class="kpi">${body || `<div class="muted">Нет упражнений.</div>`}</div>
        </div>
      `;
    }).join("");

    list.querySelectorAll(".delSessionBtn").forEach(btn => {
      btn.addEventListener("click", (e) => {
        deleteSessionById(e.currentTarget.dataset.id);
      });
    });
  }

  function buildWorkoutsRowsAll() {
    const rows = [["date", "month", "workout", "exercise", "setNo", "weight", "reps"]];
    history.forEach(h => {
      (h.items || []).forEach(it => {
        (it.sets || []).forEach(s => {
          rows.push([h.date, h.month, h.workout, it.ex, s.setNo, s.weight, s.reps]);
        });
      });
    });
    return rows;
  }

  function buildBodyRowsAll() {
    const rows = [["dateISO", "dateFormatted", "weight", "chest", "biceps", "waist", "hips", "updatedAt"]];
    const keys = Object.keys(bodyWeeklyMap || {}).sort();
    keys.forEach(k => {
      const v = bodyWeeklyMap[k] || {};
      rows.push([k, fmt(k), v.weight, v.chest, v.biceps, v.waist, v.hips, v.updatedAt]);
    });
    return rows;
  }

  function buildNotesRowsAll() {
    const rows = [["exercise", "note", "updatedAt"]];
    const entries = Object.entries(EX_NOTES || {});
    entries.forEach(([ex, note]) => {
      rows.push([ex, note, EX_NOTES_UPDATED_AT]);
    });
    return rows;
  }

  function exportXlsxAll() {
    const wb = XLSX.utils.book_new();
    const wsWorkouts = XLSX.utils.aoa_to_sheet(buildWorkoutsRowsAll());
    const wsBody = XLSX.utils.aoa_to_sheet(buildBodyRowsAll());
    const wsNotes = XLSX.utils.aoa_to_sheet(buildNotesRowsAll());
    XLSX.utils.book_append_sheet(wb, wsWorkouts, "Workouts");
    XLSX.utils.book_append_sheet(wb, wsBody, "Body");
    XLSX.utils.book_append_sheet(wb, wsNotes, "Notes");
    XLSX.writeFile(wb, `workout_tracker_export_${todayISO()}.xlsx`);
  }

  el("exportXlsx")?.addEventListener("click", async () => {
    if (!Object.keys(bodyWeeklyMap || {}).length) {
      await loadBodyWeekly();
    }
    exportXlsxAll();
  });

  // ---------------------------
  // Progress: last vs prev
  // ---------------------------
  function buildProgressLastVsPrev() {
    const byWorkout = new Map();
    for (const h of history) {
      const w = h.workout || "—";
      if (!byWorkout.has(w)) byWorkout.set(w, new Map());
      const exMap = byWorkout.get(w);
      for (const it of (h.items || [])) {
        const best = Math.max(...(it.sets || []).map(s => Number(s.weight || 0)), 0);
        if (!exMap.has(it.ex)) exMap.set(it.ex, []);
        exMap.get(it.ex).push({ ex: it.ex, date: h.date, best });
      }
    }

    const groups = [];
    const workoutNames = Array.from(byWorkout.keys()).sort((a, b) => a.localeCompare(b));
    workoutNames.forEach(w => {
      const exMap = byWorkout.get(w);
      const items = [];
      for (const [ex, arr] of exMap.entries()) {
        arr.sort((a, b) => b.date.localeCompare(a.date));
        const last = arr[0];
        const prev = arr[1];
        const lastW = last?.best ?? 0;
        const prevW = prev?.best ?? 0;
        const delta = lastW - prevW;
        items.push({ ex, lastW, prevW, delta, hasPrev: arr.length > 1 });
      }
      items.sort((a, b) => a.ex.localeCompare(b.ex));
      groups.push({ workout: w, items });
    });
    return groups;
  }

  function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function renderProgress() {
  const groups = buildProgressLastVsPrev();
  const wrap = el("progressTableWrap");
  if (!wrap) return;

  if (!groups.length) {
    wrap.innerHTML = `<div class="muted">Недостаточно данных.</div>`;
    return;
  }

  wrap.innerHTML = `<div class="progressGroups" id="progressGroups"></div>`;
  const list = el("progressGroups");

  list.innerHTML = groups.map(g => {
    const itemsHtml = g.items.map(r => {
      const lastTxt = r.lastW ? `${r.lastW} кг` : "—";
      const prevTxt = r.hasPrev ? `${r.prevW} кг` : "—";

      let deltaHtml = `<span class="deltaEq">—</span>`;
      if (r.hasPrev) {
        if (r.delta > 0) deltaHtml = `<span class="deltaPlus">+${r.delta} кг</span>`;
        else if (r.delta < 0) deltaHtml = `<span class="deltaMinus">${r.delta} кг</span>`;
        else deltaHtml = `<span class="deltaEq">0 кг</span>`;
      }

      return `
        <div class="progressExercise">
          <div class="progressExerciseTitle">${escapeHtml(r.ex)}</div>

          <div class="pGrid">
            <div class="pRow">
              <div class="pLbl">Последний</div>
              <div class="pVal">${lastTxt}</div>
            </div>

            <div class="pRow">
              <div class="pLbl">Предыдущий</div>
              <div class="pVal" style="opacity:${r.hasPrev ? 1 : .7}">${prevTxt}</div>
            </div>

            <div class="pRow">
              <div class="pLbl">Δ</div>
              <div class="pVal">${deltaHtml}</div>
            </div>
          </div>
        </div>
      `;
    }).join("");

    return `
      <div class="card progressWorkout" data-workout="${escapeHtml(g.workout)}">
        <div class="progressWorkoutHeader">${escapeHtml(g.workout)}</div>
        <div class="progressExercises">
          ${itemsHtml}
        </div>
      </div>
    `;
  }).join("");
}
  

  // ---------------------------
  // Admin
  // ---------------------------
  el("adminLoadBtn")?.addEventListener("click", async () => {
    if (!isAdminLocal()) return adminMsg("Нет доступа", true);

    const sel = el("adminUserSelect");
    const targetUid = sel ? sel.value : "";
    const program = await loadProgramDoc(targetUid);

    if (!program) {
      const ta = el("adminProgramJson");
      if (ta) ta.value = "";
      return adminMsg("У пользователя нет сохранённой программы. Нажми «Скопировать дефолт» и «Сохранить».");
    }

    el("adminProgramJson").value = JSON.stringify(program, null, 2);
    adminMsg("Загружено.");
  });

  el("adminCopyDefaultBtn")?.addEventListener("click", () => {
    if (!isAdminLocal()) return adminMsg("Нет доступа", true);
    el("adminProgramJson").value = JSON.stringify(DEFAULT_PROGRAM, null, 2);
    adminMsg("Дефолт вставлен. Правь JSON и жми «Сохранить».");
  });

  el("adminSaveBtn")?.addEventListener("click", async () => {
    if (!isAdminLocal()) return adminMsg("Нет доступа", true);

    const targetUid = el("adminUserSelect").value;
    const raw = el("adminProgramJson").value.trim();
    if (!raw) return adminMsg("Пустой JSON", true);

    let programObj;
    try {
      programObj = JSON.parse(raw);
    } catch (e) {
      return adminMsg("JSON не парсится. Проверь запятые/кавычки.", true);
    }

    const err = validateProgramShape(programObj);
    if (err) return adminMsg(err, true);

    try {
      await saveProgramDoc(targetUid, programObj);
      adminMsg("Сохранено в Firestore.");

      if (user && targetUid === user.uid) {
        PROGRAM = programObj;
      }
      renderWorkoutSelect();
    } catch (e) {
      console.error(e);
      adminMsg("Не удалось сохранить (проверь Rules).", true);
    }
  });

 await setPersistence(auth, browserLocalPersistence);

onAuthStateChanged(auth, async (u) => {
  setLoading(true, "Проверяю вход…");

  // прячем экраны, но BOOT НЕ прячем
  show("screenLogin", false);
  show("screenApp", false);
  show("logoutBtn", false);
  show("adminTabBtn", false);
  setSub("Загрузка…");

  try {
    if (!u) {
      user = null;
      profile = null;
      history = [];
      PROGRAM = DEFAULT_PROGRAM;
      EX_NOTES = {};
      EX_NOTES_UPDATED_AT = null;

      setLoading(false);
      show("screenLogin", true);
      setSub("Вход");
      return;
    }

    user = u;

    // program
    let loaded = await loadProgramDoc(user.uid);
    if (!loaded) {
      await saveProgramDoc(user.uid, DEFAULT_PROGRAM);
      loaded = DEFAULT_PROGRAM;
    }
    PROGRAM = loaded;

    // profile
    const ref = doc(db, "users", user.uid);
    const snap = await getDoc(ref);
    profile = snap.exists() ? snap.data() : { nick: "—" };

    // exercise notes
    await loadExerciseNotes();

    // history
    await loadHistory();

    // body weekly + init UI
    await loadBodyWeekly();
    initBodyUI();
    renderBodyWeightChart();
    renderBodyMeasTable();

    // UI
    el("profileName").textContent = profile.nick || "—";
    setSub(profile.nick || "—");

    setLoading(false);

    show("screenApp", true);
    show("logoutBtn", true);
    show("adminTabBtn", user.uid === ADMIN_UID);

    setActiveTabUI("dashboard");
    renderWorkoutSelect();
    renderDashboard();
    renderHistory();
    renderProgress();
    updateGoStartButton();
  } catch (err) {
    console.error("Auth init failed:", err);

    setLoading(false);

    show("screenLogin", true);
    show("screenApp", false);
    setSub("Вход");
  }
});

  // ---------------------------
  // Login / Logout
  // ---------------------------
  el("loginBtn")?.addEventListener("click", async () => {
    const nick = (el("nick")?.value || "").trim().toLowerCase();
    const pass = (el("pass")?.value || "").trim();

    const hint = el("loginHint"); // может отсутствовать
    const showHint = (html) => {
      if (!hint) return;
      hint.style.display = "";
      hint.innerHTML = html;
    };

    if (!nick || !pass) {
      showHint(`<b>Ошибка:</b> Заполни никнейм и пароль.`);
      return;
    }

    const email = NICK_TO_EMAIL[nick];
    if (!email) {
      showHint(`<b>Ошибка:</b> Нет доступа.`);
      return;
    }

    try {
      await signInWithEmailAndPassword(auth, email, pass);
    } catch (e) {
      showHint(`<b>Ошибка:</b> Неверный никнейм или пароль.`);
      console.error(e);
    }
  });

  el("logoutBtn")?.addEventListener("click", async () => {
    await signOut(auth);

    if (el("nick")) el("nick").value = "";
    if (el("pass")) el("pass").value = "";

    const hint = el("loginHint");
    if (hint) {
      hint.style.display = "none";
      hint.innerHTML = "";
    }
  });

// ---------------------------
// Initial UI (no flicker)
// ---------------------------
show("screenBoot", true);
show("screenLogin", false);
show("screenApp", false);
show("logoutBtn", false);
show("adminTabBtn", false);
setSub("Загрузка…");

// ---------------------------
// Swipe navigation between tabs
// ---------------------------
(function initSwipeTabs(){
  const root = el("app"); // твой контейнер
  const screen = el("screenApp");
  if (!root) return;

  // порядок свайпа
  function getSwipeTabsOrder(){
    const base = ["dashboard", "select", "history", "progress"];
    if (isAdminLocal()) base.push("admin"); // админ только для админа
    return base;
  }

  // защита: не свайпать, если пользователь скроллит по вертикали / вводит данные
  function isInteractiveTarget(t){
    if (!t) return false;
    return !!t.closest?.("input, textarea, select, button, a, .tabs, canvas, video");
  }

  function isScrollableTarget(t){
    let node = t;
    while (node && node !== root && node !== screen) {
      const style = getComputedStyle(node);
      if ((style.overflowY === "auto" || style.overflowY === "scroll") && node.scrollHeight > node.clientHeight + 1) {
        return true;
      }
      node = node.parentElement;
    }
    return false;
  }

  let sx = 0, sy = 0, st = 0;
  let lastX = 0, lastT = 0, prevX = 0, prevT = 0;
  let locked = false, dragging = false, animating = false;
  let dir = 0, nextTab = null;
  let currentPane = null, nextPane = null;
  let prevDisplayCurrent = "", prevDisplayNext = "";
  let prevHeight = "";
  let baseX = 0;
  let rafId = 0, pendingX = 0;

  function setTransforms(x){
    if (!currentPane || !nextPane) return;
    const w = window.innerWidth || 1;
    currentPane.style.transform = `translate3d(${x}px,0,0)`;
    nextPane.style.transform = `translate3d(${x + baseX}px,0,0)`;
    const progress = Math.min(1, Math.abs(x) / w);
    nextPane.style.setProperty("--dim", (0.12 * (1 - progress)).toFixed(3));
  }

  function scheduleTransform(x){
    pendingX = x;
    if (rafId) return;
    rafId = requestAnimationFrame(() => {
      rafId = 0;
      setTransforms(pendingX);
    });
  }

  function startDrag(){
    if (!screen) return false;
    currentPane = el("tab-" + activeTab);
    nextPane = el("tab-" + nextTab);
    if (!currentPane || !nextPane) return false;

    const tabs = screen.querySelector(".tabs");
    const h = screen.getBoundingClientRect().height;
    prevHeight = screen.style.height;
    screen.style.height = h + "px";
    if (tabs) screen.style.setProperty("--tabsH", `${tabs.getBoundingClientRect().height}px`);
    screen.classList.add("swiping");

    prevDisplayCurrent = currentPane.style.display;
    prevDisplayNext = nextPane.style.display;

    currentPane.style.display = "block";
    nextPane.style.display = "block";
    currentPane.classList.add("swipe-layer", "swipe-current");
    nextPane.classList.add("swipe-layer", "swipe-next");

    baseX = dir > 0 ? (window.innerWidth || 0) : -(window.innerWidth || 0);
    currentPane.style.transform = "translate3d(0,0,0)";
    nextPane.style.transform = `translate3d(${baseX}px,0,0)`;
    nextPane.style.setProperty("--dim", "0.12");
    return true;
  }

  function cleanup(complete){
    if (rafId) { cancelAnimationFrame(rafId); rafId = 0; }
    if (screen) {
      screen.classList.remove("swiping");
      screen.style.height = prevHeight;
      screen.style.removeProperty("--tabsH");
    }
    [currentPane, nextPane].forEach(p => {
      if (!p) return;
      p.classList.remove("swipe-layer", "swipe-current", "swipe-next", "swipe-anim");
      p.style.transform = "";
      p.style.removeProperty("--dim");
    });
    if (!complete) {
      if (currentPane) currentPane.style.display = prevDisplayCurrent;
      if (nextPane) nextPane.style.display = prevDisplayNext;
    }
    currentPane = null;
    nextPane = null;
    nextTab = null;
    dir = 0;
    dragging = false;
    locked = false;
    animating = false;
  }

  root.addEventListener("touchstart", (e) => {
    if (!e.touches || e.touches.length !== 1) return;
    if (animating) return;

    const t = e.target;
    if (isInteractiveTarget(t)) return;
    if (isScrollableTarget(t)) return;

    const order = getSwipeTabsOrder();
    if (order.indexOf(activeTab) === -1) return;

    sx = e.touches[0].clientX;
    sy = e.touches[0].clientY;
    st = Date.now();
    lastX = sx;
    lastT = st;
    prevX = sx;
    prevT = st;
    locked = false;
    dragging = false;
    nextTab = null;
    dir = 0;
  }, { passive: true });

  root.addEventListener("touchmove", (e) => {
    if (!st) return;
    if (!e.touches || e.touches.length !== 1) return;

    const t = e.target;
    if (!dragging && isInteractiveTarget(t)) { st = 0; return; }

    const touch = e.touches[0];
    const dx = touch.clientX - sx;
    const dy = touch.clientY - sy;

    if (!locked) {
      if (Math.abs(dx) < 8 && Math.abs(dy) < 8) return;
      if (Math.abs(dy) > Math.abs(dx) * 1.1) { st = 0; return; }
      if (Math.abs(dx) > Math.abs(dy) * 1.1) {
        locked = true;
        dir = dx < 0 ? 1 : -1;
        const order = getSwipeTabsOrder();
        const i = order.indexOf(activeTab);
        const nextIndex = dir > 0 ? i + 1 : i - 1;
        if (nextIndex < 0 || nextIndex >= order.length) { st = 0; locked = false; return; }
        nextTab = order[nextIndex];
        dragging = startDrag();
        if (!dragging) { st = 0; locked = false; return; }
      }
    }

    if (!dragging) return;

    e.preventDefault();
    prevX = lastX;
    prevT = lastT;
    lastX = touch.clientX;
    lastT = Date.now();

    const w = window.innerWidth || 1;
    const clamped = Math.max(-w, Math.min(w, dx));
    scheduleTransform(clamped);
  }, { passive: false });

  function finishSwipe(complete){
    if (!dragging || !currentPane || !nextPane) { cleanup(false); return; }
    animating = true;
    currentPane.classList.add("swipe-anim");
    nextPane.classList.add("swipe-anim");

    const w = window.innerWidth || 1;
    const endX = complete ? (dir > 0 ? -w : w) : 0;
    requestAnimationFrame(() => {
      setTransforms(endX);
    });

    let finished = false;
    const done = () => {
      if (finished) return;
      finished = true;
      if (complete) {
        if (nextTab === "history") { setActiveTabUI("history"); renderHistory(); cleanup(true); return; }
        if (nextTab === "progress") { setActiveTabUI("progress"); renderProgress(); cleanup(true); return; }
        if (nextTab === "select") { setActiveTabUI("select"); renderWorkoutSelect(); cleanup(true); return; }
        if (nextTab === "dashboard") { setActiveTabUI("dashboard"); renderDashboard(); cleanup(true); return; }
        if (nextTab === "admin") { setActiveTabUI("admin"); cleanup(true); return; }
      }
      cleanup(false);
    };

    currentPane.addEventListener("transitionend", done, { once: true });
    setTimeout(done, 260);
  }

  function onEnd(e){
    if (!st) return;
    if (!dragging) { st = 0; return; }

    const touch = e.changedTouches?.[0];
    if (!touch) { st = 0; finishSwipe(false); return; }

    const dx = touch.clientX - sx;
    const w = window.innerWidth || 1;
    const v = (lastT > prevT) ? (lastX - prevX) / Math.max(1, lastT - prevT) : 0;
    const fast = Math.abs(v) > 0.6;
    const far = Math.abs(dx) > w * 0.25;

    st = 0;
    finishSwipe(far || fast);
  }

  root.addEventListener("touchend", onEnd, { passive: true });
  root.addEventListener("touchcancel", onEnd, { passive: true });
})();


</script>

<div class="toast" id="toast">
  <div class="toastRow">
    <div class="toastMsg" id="toastMsg">Удалено</div>
    <button class="toastBtn" id="toastUndoBtn">UNDO (5s)</button>
  </div>
</div>



<div id="machineModal" style="display:none; position:fixed; inset:0; z-index:9999;">
  <div id="machineBackdrop" style="position:absolute; inset:0; background:rgba(0,0,0,.6);"></div>

  <div style="position:relative; margin:8vh auto 0; width:min(92vw, 420px);">
    <div class="card" style="padding:12px; margin:0;">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
        <div style="font-weight:900;">Тренажёр</div>
        <button class="iconbtn" id="machineClose" type="button" title="Закрыть">✕</button>
      </div>

      <div style="margin-top:10px;">
        <img id="machineImg" src="" alt="Тренажёр"
             style="width:100%; height:auto; border-radius:18px; border:1px solid var(--border); display:block;" />
      </div>

      <div class="muted" id="machineErr" style="display:none; margin-top:10px;">
        Не удалось загрузить изображение. Проверь ссылку.
      </div>
    </div>
  </div>
</div>

<div id="videoModal" style="display:none; position:fixed; inset:0; z-index:9999;">
  <div id="videoBackdrop" style="position:absolute; inset:0; background:rgba(0,0,0,.6);"></div>

  <div style="position:relative; margin:8vh auto 0; width:min(92vw, 420px);">
    <div class="card" style="padding:12px; margin:0;">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
        <div style="font-weight:900;">Видео</div>
        <button class="iconbtn" id="videoClose" type="button" title="Закрыть">✕</button>
      </div>

      <div style="margin-top:10px;">
        <video id="videoPlayer"
               controls
               playsinline
               preload="metadata"
               style="width:100%; height:auto; border-radius:18px; border:1px solid var(--border); display:block; background:#000;">
        </video>
      </div>

      <div class="muted" id="videoErr" style="display:none; margin-top:10px;">
        Не удалось загрузить видео. Проверь ссылку или формат.
      </div>
    </div>
  </div>
</div>

</body>
</html>
