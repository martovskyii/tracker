<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Workout Tracker — Rings Demo</title>
  <style>
    :root{
      --bg:#0b0b0c; --panel:#121214; --border:#2a2a2a;
      --text:#fff; --muted:rgba(255,255,255,.7);
      --btn:#ffffff; --btnText:#000; --btn2:#1a1a1b; --btn2Text:#fff;
      --danger:#ff6b6b; --success:#32d583;
      --ringMove:#4da3ff;
      --ringTrain:#32d583;
      --ringBody:#dd77af;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg); color:var(--text);
    }
    .wrap{max-width:980px;margin:0 auto;padding:18px 14px 32px}
    .top{
      display:flex; align-items:flex-start; justify-content:space-between; gap:14px;
      margin-bottom:12px;
    }
    .card{
      border:1px solid var(--border);
      background:var(--panel);
      border-radius:22px;
      padding:14px;
      margin:12px 0;
    }
    h1{margin:0;font-size:18px}
    .muted{color:var(--muted);font-size:13px}
    .grid{
      display:grid;
      grid-template-columns: 1.25fr 0.75fr;
      gap:12px;
    }
    @media(max-width:860px){
      .grid{grid-template-columns:1fr}
    }

    /* Rings */
    .ringsRow{display:flex;gap:14px;flex-wrap:wrap;align-items:center}
    .ringBox{display:flex;align-items:center;gap:12px}
    .ringCanvas{width:84px;height:84px}
    .ringMeta b{display:block;font-size:14px}
    .ringMeta span{display:block;font-size:12px;color:var(--muted);margin-top:2px}
    .ringPct{
      margin-top:6px; font-size:12px; color:var(--muted);
      display:flex; gap:8px; align-items:center;
    }
    .pill{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:transparent;
      color:var(--muted);
      font-size:12px;
      margin:6px 6px 0 0;
      user-select:none;
    }
    .pill.ok{border-color:rgba(50,213,131,.4); color:rgba(50,213,131,.95)}
    .pill.warn{border-color:rgba(255,107,107,.45); color:rgba(255,107,107,.95)}
    .pill.pink{border-color:rgba(221,119,175,.45); color:rgba(221,119,175,.95)}
    .pill.blue{border-color:rgba(77,163,255,.45); color:rgba(77,163,255,.95)}

    /* Controls */
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input, select{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:transparent;
      color:var(--text);
      outline:none;
      font-size:16px;
      -webkit-text-size-adjust:100%;
    }
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .btn{
      width:100%;
      border:none;
      padding:12px 14px;
      border-radius:16px;
      cursor:pointer;
      font-weight:800;
    }
    .btn.primary{background:var(--btn);color:var(--btnText)}
    .btn.secondary{background:var(--btn2);color:var(--btn2Text);border:1px solid var(--border)}
    .btn.danger{background:transparent;border:1px solid rgba(255,107,107,.45);color:rgba(255,107,107,.95)}
    .btn:disabled{opacity:.55;cursor:not-allowed}

    /* Table */
    table{
      width:100%;
      border-collapse:collapse;
      overflow:hidden;
      border-radius:18px;
      border:1px solid var(--border);
    }
    th, td{
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      font-size:13px;
      text-align:left;
    }
    th{color:var(--muted);font-weight:800;background:rgba(255,255,255,.06)}
    tr:last-child td{border-bottom:none}
    .actionsCell{white-space:nowrap}
    .miniBtn{
      padding:8px 10px;
      border-radius:12px;
      border:1px solid var(--border);
      background:transparent;
      color:var(--text);
      cursor:pointer;
      font-weight:800;
      font-size:12px;
    }
    .miniBtn.del{border-color:rgba(255,107,107,.45);color:rgba(255,107,107,.95)}
    .miniBtn.pr{border-color:rgba(50,213,131,.45);color:rgba(50,213,131,.95)}
    .kpi{
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      border-radius:18px;
      padding:12px;
      margin-top:10px;
    }
    .bar{
      height:10px;border-radius:999px;
      background:rgba(255,255,255,.10);
      overflow:hidden;border:1px solid var(--border);
      margin-top:8px;
    }
    .bar > div{
      height:100%;
      width:0%;
      background:var(--btn);
      transition:width .25s ease;
    }
    .small{font-size:12px;color:var(--muted)}
    .footer{margin-top:18px;text-align:center;font-size:11px;color:var(--muted)}
    code{color:rgba(255,255,255,.85)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>Rings Demo</h1>
        <div class="muted">Тестовая страница: 3 кольца (Move / Train / Body) + стрики + бейджи. Данные живут в <code>localStorage</code>.</div>
      </div>
      <div style="min-width:220px">
        <button class="btn danger" id="resetAll">Сбросить демо-данные</button>
      </div>
    </div>

    <div class="card">
      <div class="ringsRow">
        <div class="ringBox">
          <canvas class="ringCanvas" id="ringMove" width="84" height="84"></canvas>
          <div class="ringMeta">
            <b>Move</b>
            <span>Тренировки / неделя</span>
            <div class="ringPct" id="moveText">—</div>
          </div>
        </div>

        <div class="ringBox">
          <canvas class="ringCanvas" id="ringTrain" width="84" height="84"></canvas>
          <div class="ringMeta">
            <b>Train</b>
            <span>Подходы / неделя</span>
            <div class="ringPct" id="trainText">—</div>
          </div>
        </div>

        <div class="ringBox">
          <canvas class="ringCanvas" id="ringBody" width="84" height="84"></canvas>
          <div class="ringMeta">
            <b>Body</b>
            <span>Замер / неделя</span>
            <div class="ringPct" id="bodyText">—</div>
          </div>
        </div>

        <div style="flex:1;min-width:240px">
          <div class="kpi">
            <div style="display:flex;justify-content:space-between;gap:10px;align-items:center">
              <div style="font-weight:900">Неделя</div>
              <div class="muted" id="weekLabel">—</div>
            </div>
            <div class="bar"><div id="weekBar"></div></div>
            <div class="small" id="weekSummary" style="margin-top:8px">—</div>
          </div>

          <div style="margin-top:10px">
            <span class="pill blue" id="streakMove">Move streak: —</span>
            <span class="pill ok" id="streakTrain">Train streak: —</span>
            <span class="pill pink" id="streakBody">Body streak: —</span>
          </div>
        </div>
      </div>

      <div style="margin-top:14px">
        <div style="font-weight:900;margin-bottom:6px">Бейджи</div>
        <div id="badges" class="muted">Пока нет бейджей. Добавь тренировки/подходы/замер.</div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div style="font-weight:900;margin-bottom:6px">Добавить событие (для теста)</div>
        <div class="muted">Можно набросать “как будто тренировка была” и посмотреть, как меняются кольца/стрики/бейджи.</div>

        <div class="row2" style="margin-top:10px">
          <div>
            <label>Дата (локальная)</label>
            <input type="date" id="dDate" />
          </div>
          <div>
            <label>Тип</label>
            <select id="dType">
              <option value="workout">Тренировка (Move)</option>
              <option value="sets">Подходы (Train)</option>
              <option value="body">Замер тела (Body)</option>
              <option value="pr">PR по упражнению</option>
            </select>
          </div>
        </div>

        <div id="workoutFields" style="margin-top:10px">
          <label>Название тренировки</label>
          <input id="wName" placeholder="например: Вверх" />
        </div>

        <div id="setsFields" style="margin-top:10px;display:none">
          <div class="row2">
            <div>
              <label>Подходов (шт)</label>
              <input id="sCount" type="number" min="1" value="12" />
            </div>
            <div>
              <label>Упражнений (шт)</label>
              <input id="sEx" type="number" min="1" value="5" />
            </div>
          </div>
        </div>

        <div id="bodyFields" style="margin-top:10px;display:none">
          <div class="row2">
            <div>
              <label>Вес (кг)</label>
              <input id="bWeight" type="number" step="0.1" placeholder="например 60.5" />
            </div>
            <div>
              <label>Грудь (см)</label>
              <input id="bChest" type="number" step="0.1" placeholder="например 92" />
            </div>
          </div>
          <div class="row2">
            <div>
              <label>Талия (см)</label>
              <input id="bWaist" type="number" step="0.1" placeholder="например 68" />
            </div>
            <div>
              <label>Бёдра (см)</label>
              <input id="bHips" type="number" step="0.1" placeholder="например 96" />
            </div>
          </div>
          <div class="muted" style="margin-top:8px">Запись сохраняется как “неделя (понедельник)”.</div>
        </div>

        <div id="prFields" style="margin-top:10px;display:none">
          <div class="row2">
            <div>
              <label>Упражнение</label>
              <input id="prName" placeholder="например: Жим гантелей" />
            </div>
            <div>
              <label>Вес (кг)</label>
              <input id="prWeight" type="number" step="0.5" placeholder="например 22.5" />
            </div>
          </div>
          <div class="muted" style="margin-top:8px">PR бейдж прилетает, если вес больше прошлого PR.</div>
        </div>

        <div style="margin-top:12px" class="row2">
          <button class="btn primary" id="addDemo">Добавить</button>
          <button class="btn secondary" id="add3weeks">Набросать 3 недели</button>
        </div>
      </div>

      <div class="card">
        <div style="font-weight:900;margin-bottom:6px">Лог событий</div>
        <div class="muted">Удаление поштучно (как ты хочешь для замеров/подходов).</div>
        <div id="logWrap" style="margin-top:10px" class="muted">Пока пусто.</div>
      </div>
    </div>

    <div class="footer">Если ок — перенесём это в прод аккуратно: функции расчёта + рендер, без поломки текущего UI.</div>
  </div>

<script>
/* ---------------------------
   Demo storage model
   ---------------------------
   data = {
     workouts: [{id, dateISO, name}],
     sets: [{id, dateISO, setsCount, exCount}],
     bodyWeekly: { mondayISO: {weight,chest,waist,hips, updatedAt} },
     prs: { [exerciseName]: bestWeight },
     badges: [{id, ts, type, text, weekKey?}],
     weeklyCloseHistory: { [weekKey]: {moveClosed, trainClosed, bodyClosed} } // for streaks
   }
*/
const LS_KEY = "wt_rings_demo_v1";

function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }

function loadData(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return freshData();
    const d = JSON.parse(raw);
    return { ...freshData(), ...d };
  }catch(e){ return freshData(); }
}
function saveData(){
  localStorage.setItem(LS_KEY, JSON.stringify(data));
}
function freshData(){
  return {
    workouts: [],
    sets: [],
    bodyWeekly: {},
    prs: {},
    badges: [],
    weeklyCloseHistory: {}
  };
}

function todayISO(){
  const d = new Date();
  const tz = d.getTimezoneOffset()*60000;
  return new Date(Date.now()-tz).toISOString().slice(0,10);
}
function fmtISO(iso){
  const [y,m,d]=iso.split("-");
  return `${d}.${m}.${y}`;
}
function mondayOf(dateISO){
  const [y,m,d]=dateISO.split("-").map(Number);
  const dt = new Date(y,m-1,d);
  const day = (dt.getDay()+6)%7; // Mon=0..Sun=6
  dt.setDate(dt.getDate()-day);
  const tz = dt.getTimezoneOffset()*60000;
  return new Date(dt.getTime()-tz).toISOString().slice(0,10);
}
function weekKey(dateISO){ return mondayOf(dateISO); } // monday ISO as week key
function weekRange(mondayISO){
  const [y,m,d]=mondayISO.split("-").map(Number);
  const mon = new Date(y,m-1,d);
  const sun = new Date(mon); sun.setDate(mon.getDate()+6);
  const toISO=(x)=>{
    const tz=x.getTimezoneOffset()*60000;
    return new Date(x.getTime()-tz).toISOString().slice(0,10);
  };
  return {start: toISO(mon), end: toISO(sun)};
}
function isInWeek(dateISO, mondayISO){
  const {start,end}=weekRange(mondayISO);
  return dateISO>=start && dateISO<=end;
}

/* ---------------------------
   Goals (tune later)
   --------------------------- */
const GOALS = {
  movePerWeek: 3,
  setsPerWeek: 40,
  bodyPerWeek: 1
};

/* ---------------------------
   Badges logic
   --------------------------- */
function addBadge(type, text, weekKeyMaybe=null){
  const id = uid();
  data.badges.unshift({ id, ts: Date.now(), type, text, weekKey: weekKeyMaybe });
  // keep last 50
  data.badges = data.badges.slice(0,50);
}
function ensureWeekCloseRecorded(wk, closedObj){
  data.weeklyCloseHistory[wk] = closedObj;
}
function computeStreak(getClosed){
  // streak ending at current week, going backwards while condition true
  const currWk = weekKey(todayISO());
  let streak = 0;
  let wk = currWk;

  for(let i=0;i<260;i++){ // 5 years max
    const hist = data.weeklyCloseHistory[wk];
    if(!hist) break;
    if(!getClosed(hist)) break;
    streak++;
    // previous week:
    const [y,m,d]=wk.split("-").map(Number);
    const dt=new Date(y,m-1,d);
    dt.setDate(dt.getDate()-7);
    const tz=dt.getTimezoneOffset()*60000;
    wk = new Date(dt.getTime()-tz).toISOString().slice(0,10);
  }
  return streak;
}

/* ---------------------------
   Rings compute
   --------------------------- */
function computeWeekStats(mondayISO){
  const workouts = data.workouts.filter(w => isInWeek(w.dateISO, mondayISO));
  const setsRows = data.sets.filter(s => isInWeek(s.dateISO, mondayISO));
  const body = data.bodyWeekly[mondayISO] ? 1 : 0;

  const workoutCount = workouts.length;
  const setsCount = setsRows.reduce((a,b)=>a + Number(b.setsCount||0), 0);

  const movePct = workoutCount / GOALS.movePerWeek;
  const trainPct = setsCount / GOALS.setsPerWeek;
  const bodyPct = body / GOALS.bodyPerWeek;

  const moveClosed = workoutCount >= GOALS.movePerWeek;
  const trainClosed = setsCount >= GOALS.setsPerWeek;
  const bodyClosed = body >= GOALS.bodyPerWeek;

  return {
    mondayISO,
    workoutCount,
    setsCount,
    bodyDone: body===1,
    movePct, trainPct, bodyPct,
    moveClosed, trainClosed, bodyClosed
  };
}

function updateWeekCloseAndBadges(stats){
  const wk = stats.mondayISO;
  const prev = data.weeklyCloseHistory[wk] || {moveClosed:false, trainClosed:false, bodyClosed:false, all3:false};

  const now = {
    moveClosed: stats.moveClosed,
    trainClosed: stats.trainClosed,
    bodyClosed: stats.bodyClosed,
    all3: (stats.moveClosed && stats.trainClosed && stats.bodyClosed)
  };

  // New closures -> badges (only once per week)
  if(!prev.moveClosed && now.moveClosed) addBadge("close", `Move закрыто (${stats.workoutCount}/${GOALS.movePerWeek})`, wk);
  if(!prev.trainClosed && now.trainClosed) addBadge("close", `Train закрыто (${stats.setsCount}/${GOALS.setsPerWeek} подходов)`, wk);
  if(!prev.bodyClosed && now.bodyClosed) addBadge("close", `Body закрыто (замер на неделю ${fmtISO(wk)})`, wk);

  if(!prev.all3 && now.all3) addBadge("all3", `3/3 кольца закрыто за неделю ${fmtISO(wk)}`, wk);

  ensureWeekCloseRecorded(wk, now);

  // milestone streak badge (optional): when all3 streak hits 4 or 8 etc.
  const all3Streak = computeStreak(h => h.all3);
  if(all3Streak === 4) addBadge("streak", `Стрик 3/3: 4 недели подряд`, wk);
  if(all3Streak === 8) addBadge("streak", `Стрик 3/3: 8 недель подряд`, wk);
}

/* ---------------------------
   Ring drawing (canvas)
   --------------------------- */
function drawRing(canvas, pctRaw, color, label){
  const ctx = canvas.getContext("2d");
  const w = canvas.width, h = canvas.height;
  ctx.clearRect(0,0,w,h);

  // background track
  const cx=w/2, cy=h/2;
  const r=32;
  ctx.lineWidth = 10;
  ctx.lineCap = "round";

  // track
  ctx.strokeStyle = "rgba(255,255,255,.10)";
  ctx.beginPath();
  ctx.arc(cx,cy,r,0,Math.PI*2);
  ctx.stroke();

  // progress (allow >100% but cap at 200% visually by drawing 2 laps)
  const pct = Math.max(0, pctRaw);
  const laps = Math.min(2, pct); // show up to 200% as 2 laps
  const frac = laps % 1;
  const fullLaps = Math.floor(laps);

  const start = -Math.PI/2;

  ctx.strokeStyle = color;

  // draw full laps (as same circle, thicker highlight)
  for(let i=0;i<fullLaps;i++){
    ctx.globalAlpha = 1;
    ctx.beginPath();
    ctx.arc(cx,cy,r,start,start + Math.PI*2);
    ctx.stroke();
  }

  // draw remainder lap
  if(frac > 0){
    ctx.globalAlpha = 1;
    ctx.beginPath();
    ctx.arc(cx,cy,r,start,start + Math.PI*2*frac);
    ctx.stroke();
  }

  // center text
  ctx.globalAlpha = 1;
  ctx.fillStyle = "rgba(255,255,255,.9)";
  ctx.font = "900 12px system-ui,-apple-system,Segoe UI,Roboto,Arial";
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  const pctTxt = Math.round(Math.min(999, pctRaw*100));
  ctx.fillText(`${pctTxt}%`, cx, cy);

  // small label
  ctx.fillStyle = "rgba(255,255,255,.55)";
  ctx.font = "800 10px system-ui,-apple-system,Segoe UI,Roboto,Arial";
  ctx.fillText(label, cx, cy+18);
}

/* ---------------------------
   Render UI
   --------------------------- */
const $ = (id)=>document.getElementById(id);

let data = loadData();

function render(){
  // current week
  const currWk = weekKey(todayISO());
  const stats = computeWeekStats(currWk);

  // update closures + badges/streaks
  updateWeekCloseAndBadges(stats);

  saveData();

  // rings
  drawRing($("ringMove"), stats.movePct, getCSS("--ringMove"), "Move");
  drawRing($("ringTrain"), stats.trainPct, getCSS("--ringTrain"), "Train");
  drawRing($("ringBody"), stats.bodyPct, getCSS("--ringBody"), "Body");

  $("moveText").textContent = `${stats.workoutCount}/${GOALS.movePerWeek} тренировки`;
  $("trainText").textContent = `${stats.setsCount}/${GOALS.setsPerWeek} подходов`;
  $("bodyText").textContent = stats.bodyDone ? `1/${GOALS.bodyPerWeek} замер` : `0/${GOALS.bodyPerWeek} замер`;

  // week summary bar = how many rings closed (0..3)
  const closed = [stats.moveClosed, stats.trainClosed, stats.bodyClosed].filter(Boolean).length;
  $("weekLabel").textContent = `Неделя (пн): ${fmtISO(currWk)}`;
  $("weekSummary").textContent = `${closed}/3 кольца закрыто • Move ${stats.workoutCount}, Train ${stats.setsCount}, Body ${stats.bodyDone ? "да" : "нет"}`;
  $("weekBar").style.width = Math.round((closed/3)*100) + "%";

  // streaks
  const moveStreak = computeStreak(h => h.moveClosed);
  const trainStreak = computeStreak(h => h.trainClosed);
  const bodyStreak = computeStreak(h => h.bodyClosed);
  $("streakMove").textContent = `Move streak: ${moveStreak} нед.`;
  $("streakTrain").textContent = `Train streak: ${trainStreak} нед.`;
  $("streakBody").textContent = `Body streak: ${bodyStreak} нед.`;

  // badges
  const bWrap = $("badges");
  if(!data.badges.length){
    bWrap.className = "muted";
    bWrap.textContent = "Пока нет бейджей. Добавь тренировки/подходы/замер.";
  }else{
    bWrap.className = "";
    bWrap.innerHTML = data.badges.slice(0,10).map(b=>{
      const when = new Date(b.ts);
      const hh = String(when.getHours()).padStart(2,"0");
      const mm = String(when.getMinutes()).padStart(2,"0");
      const tag = b.type === "all3" ? "ok" : (b.type==="streak" ? "blue" : "pink");
      return `<span class="pill ${tag}" title="${when.toLocaleString()}">${hh}:${mm} • ${escapeHtml(b.text)}</span>`;
    }).join("");
  }

  // log
  renderLog();
}

function renderLog(){
  const wrap = $("logWrap");

  const items = [];

  // workouts
  for(const w of data.workouts){
    items.push({ kind:"workout", id:w.id, dateISO:w.dateISO, text:`Тренировка: ${w.name}` });
  }
  // sets
  for(const s of data.sets){
    items.push({ kind:"sets", id:s.id, dateISO:s.dateISO, text:`Подходы: ${s.setsCount} (упр: ${s.exCount||0})` });
  }
  // body weekly -> as pseudo events
  for(const [mon, v] of Object.entries(data.bodyWeekly)){
    const parts = [];
    if(typeof v.weight==="number") parts.push(`вес ${v.weight}`);
    if(typeof v.chest==="number") parts.push(`грудь ${v.chest}`);
    if(typeof v.waist==="number") parts.push(`талия ${v.waist}`);
    if(typeof v.hips==="number") parts.push(`бёдра ${v.hips}`);
    items.push({ kind:"body", id:mon, dateISO:mon, text:`Замер (неделя): ${parts.join(", ") || "—"}` });
  }
  // PRs (as info)
  for(const [name, w] of Object.entries(data.prs)){
    items.push({ kind:"pr", id:name, dateISO:"9999-12-31", text:`PR: ${name} = ${w} кг` });
  }

  items.sort((a,b)=> (b.dateISO.localeCompare(a.dateISO)) || (a.kind.localeCompare(b.kind)));

  if(!items.length){
    wrap.className="muted";
    wrap.textContent="Пока пусто.";
    return;
  }

  wrap.className="";
  wrap.innerHTML = `
    <div style="overflow-x:auto;-webkit-overflow-scrolling:touch">
      <table>
        <thead>
          <tr>
            <th style="width:120px">Дата</th>
            <th>Событие</th>
            <th class="actionsCell" style="width:160px">Действия</th>
          </tr>
        </thead>
        <tbody>
          ${items.slice(0,30).map(it=>{
            const dateTxt = it.kind==="pr" ? "—" : fmtISO(it.dateISO);
            const delLabel = (it.kind==="body") ? "Удалить запись" : "Удалить";
            const canDel = it.kind !== "pr";
            const prBtn = it.kind==="sets" ? `<button class="miniBtn pr" data-act="bonus" data-kind="sets" data-id="${it.id}">+10 подходов</button>` : "";
            return `
              <tr>
                <td>${dateTxt}</td>
                <td>${escapeHtml(it.text)}</td>
                <td class="actionsCell">
                  ${prBtn}
                  ${canDel ? `<button class="miniBtn del" data-act="del" data-kind="${it.kind}" data-id="${it.id}">${delLabel}</button>` : ""}
                </td>
              </tr>
            `;
          }).join("")}
        </tbody>
      </table>
    </div>
  `;

  wrap.querySelectorAll("button").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const act = btn.dataset.act;
      const kind = btn.dataset.kind;
      const id = btn.dataset.id;

      if(act==="bonus" && kind==="sets"){
        const row = data.sets.find(x=>x.id===id);
        if(row){ row.setsCount = Number(row.setsCount||0) + 10; saveData(); render(); }
        return;
      }

      if(act==="del"){
        if(kind==="workout"){
          const ok = confirm("Удалить эту тренировку?");
          if(!ok) return;
          data.workouts = data.workouts.filter(x=>x.id!==id);
        }
        if(kind==="sets"){
          const ok = confirm("Удалить эту запись подходов?");
          if(!ok) return;
          data.sets = data.sets.filter(x=>x.id!==id);
        }
        if(kind==="body"){
          const ok = confirm(`Удалить замер за неделю ${fmtISO(id)}?`);
          if(!ok) return;
          delete data.bodyWeekly[id];
        }
        saveData();
        render();
      }
    });
  });
}

function getCSS(varName){
  return getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
}
function escapeHtml(s){
  return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}

/* ---------------------------
   Demo interactions
   --------------------------- */
$("dDate").value = todayISO();

$("dType").addEventListener("change", ()=>{
  const t = $("dType").value;
  $("workoutFields").style.display = (t==="workout") ? "" : "none";
  $("setsFields").style.display = (t==="sets") ? "" : "none";
  $("bodyFields").style.display = (t==="body") ? "" : "none";
  $("prFields").style.display = (t==="pr") ? "" : "none";
});

$("addDemo").addEventListener("click", ()=>{
  const dateISO = $("dDate").value || todayISO();
  const t = $("dType").value;

  if(t==="workout"){
    const name = ($("wName").value || "").trim() || "Тренировка";
    data.workouts.push({ id: uid(), dateISO, name });
  }

  if(t==="sets"){
    const setsCount = Number($("sCount").value || 0);
    const exCount = Number($("sEx").value || 0);
    if(setsCount<=0) return alert("Подходов должно быть > 0");
    data.sets.push({ id: uid(), dateISO, setsCount, exCount });
  }

  if(t==="body"){
    const mon = mondayOf(dateISO);
    const payload = {
      updatedAt: Date.now()
    };
    const w = parseNum($("bWeight").value);
    const c = parseNum($("bChest").value);
    const wa = parseNum($("bWaist").value);
    const h = parseNum($("bHips").value);
    if(w!=null) payload.weight = w;
    if(c!=null) payload.chest = c;
    if(wa!=null) payload.waist = wa;
    if(h!=null) payload.hips = h;

    if(Object.keys(payload).length===1){
      return alert("Заполни хоть одно поле (вес/параметры).");
    }

    const prev = data.bodyWeekly[mon] || {};
    data.bodyWeekly[mon] = { ...prev, ...payload };
  }

  if(t==="pr"){
    const ex = ($("prName").value || "").trim();
    const w = parseNum($("prWeight").value);
    if(!ex) return alert("Напиши упражнение.");
    if(w==null) return alert("Напиши вес.");
    const prev = Number(data.prs[ex] || 0);
    if(w > prev){
      data.prs[ex] = w;
      addBadge("pr", `Новый рекорд: ${ex} — ${w} кг (было ${prev || "—"})`);
    }else{
      // optional: no badge
      data.prs[ex] = prev; // keep
      alert(`Не PR. Текущий PR: ${prev} кг`);
    }
  }

  saveData();
  render();
});

$("add3weeks").addEventListener("click", ()=>{
  // generate sample: 3 weeks including current
  const currMon = weekKey(todayISO());
  const weeks = [0, -7, -14].map(offset=>{
    const [y,m,d]=currMon.split("-").map(Number);
    const dt=new Date(y,m-1,d);
    dt.setDate(dt.getDate()+offset);
    const tz=dt.getTimezoneOffset()*60000;
    return new Date(dt.getTime()-tz).toISOString().slice(0,10);
  });

  for(const mon of weeks){
    const {start} = weekRange(mon);
    // 3 workouts spread
    data.workouts.push({ id: uid(), dateISO: start, name:"Вверх" });
    data.workouts.push({ id: uid(), dateISO: addDaysISO(start,2), name:"Ягодицы" });
    data.workouts.push({ id: uid(), dateISO: addDaysISO(start,4), name:"Ноги" });

    // sets (total 42)
    data.sets.push({ id: uid(), dateISO: start, setsCount: 14, exCount: 5 });
    data.sets.push({ id: uid(), dateISO: addDaysISO(start,2), setsCount: 14, exCount: 5 });
    data.sets.push({ id: uid(), dateISO: addDaysISO(start,4), setsCount: 14, exCount: 5 });

    // body once
    data.bodyWeekly[mon] = { weight: 60 + Math.random()*2, chest: 90 + Math.random()*2, waist: 68 + Math.random()*2, hips: 96 + Math.random()*2, updatedAt: Date.now() };
  }

  // PR samples
  if(!data.prs["Жим гантелей"]) data.prs["Жим гантелей"]=20;
  data.prs["Жим гантелей"] += 2.5;
  addBadge("pr", `Новый рекорд: Жим гантелей — ${data.prs["Жим гантелей"]} кг`);

  saveData();
  render();
});

$("resetAll").addEventListener("click", ()=>{
  const ok = confirm("Сбросить все демо-данные?");
  if(!ok) return;
  localStorage.removeItem(LS_KEY);
  data = loadData();
  render();
});

function parseNum(v){
  if(v==="" || v==null) return null;
  const n = Number(v);
  return Number.isFinite(n) ? n : null;
}
function addDaysISO(iso, days){
  const [y,m,d]=iso.split("-").map(Number);
  const dt=new Date(y,m-1,d);
  dt.setDate(dt.getDate()+days);
  const tz=dt.getTimezoneOffset()*60000;
  return new Date(dt.getTime()-tz).toISOString().slice(0,10);
}

// init
render();
</script>
</body>
</html>
